<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Classes</title>
  <link rel="icon" href="https://ssl.gstatic.com/classroom/favicon.png" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Keep external gnmath.js for compatibility -->
  <script src="https://cdn.jsdelivr.net/gh/gn-math/gn-math.github.io@main/gnmath.js"></script>

  <style>
    :root {
      /* Premium Cyber-Dark Palette - Dark Blue Aesthetic */
      --bg-body: #020617;
      --bg-surface: rgba(15, 23, 42, 0.8);
      --bg-surface-hover: rgba(30, 41, 59, 0.9);
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --accent-color: #38bdf8;
      --accent-hover: #0ea5e9;
      --accent-glow: rgba(56, 189, 248, 0.4);
      --border-color: rgba(51, 65, 85, 0.5);
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.2), 0 10px 10px -5px rgb(0 0 0 / 0.1);
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 12px;
      --header-height: 90px;
      --glass-bg: rgba(15, 23, 42, 0.85);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    /* Light Mode Variables */
    body.light-mode {
      --bg-body: #f1f5f9;
      --bg-surface: rgba(255, 255, 255, 0.6);
      --bg-surface-hover: rgba(241, 245, 249, 0.8);
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --accent-color: #0284c7;
      --accent-hover: #0369a1;
      --accent-glow: rgba(2, 132, 199, 0.2);
      --border-color: rgba(226, 232, 240, 0.8);
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(0, 0, 0, 0.05);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0;
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-primary);
      transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Subtle Noise Texture */
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 9999;
    }

    /* Header */
    header {
      background-color: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      height: var(--header-height);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
    }

    .header-content {
      width: 100%;
      max-width: 1800px;
      margin: 0 auto;
      padding: 0 2.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 2.5rem;
    }

    .logo {
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: -0.04em;
      color: var(--text-primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: transform 0.3s ease;
    }
    
    .logo:hover { transform: scale(1.02); }
    .logo span { 
      color: var(--accent-color); 
      background: linear-gradient(135deg, var(--accent-color), #818cf8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Search & Controls */
    .controls-wrapper {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      flex: 1;
      max-width: 900px;
    }

    .search-container {
      flex: 1;
      position: relative;
    }

    #searchBar {
      width: 100%;
      padding: 0.85rem 1.25rem 0.85rem 3rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background-color: var(--bg-surface);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }

    #searchBar:focus {
      outline: none;
      border-color: var(--accent-color);
      background-color: var(--bg-surface-hover);
      box-shadow: 0 0 0 4px var(--accent-glow);
      transform: translateY(-1px);
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
      transition: color 0.3s ease;
    }

    #searchBar:focus + .search-icon {
      color: var(--accent-color);
    }

    select#sortOptions {
      padding: 0.85rem 2.5rem 0.85rem 1.25rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background-color: var(--bg-surface);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1.1rem;
      transition: all 0.3s ease;
    }

    select#sortOptions:hover {
      background-color: var(--bg-surface-hover);
      border-color: var(--text-secondary);
    }

    button#settings {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.85rem 1.5rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    button#settings:hover {
      background: var(--bg-surface-hover);
      border-color: var(--accent-color);
      transform: translateY(-1px);
    }

    /* Main Grid */
    main {
      flex: 1;
      width: 100%;
      max-width: 1800px;
      margin: 0 auto;
      padding: 3rem 2.5rem;
    }

    #zoneCount {
      margin-bottom: 2rem;
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      opacity: 0.8;
    }

    #container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 2rem;
      width: 100%;
    }

    @media (min-width: 1600px) {
      #container { grid-template-columns: repeat(8, 1fr); }
    }
    
    @media (min-width: 1200px) and (max-width: 1599px) {
      #container { grid-template-columns: repeat(6, 1fr); }
    }

    /* Card Styles */
    .zone-item {
      background-color: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
      position: relative;
      display: flex;
      flex-direction: column;
      animation: cardEntrance 0.6s ease-out backwards;
    }

    @keyframes cardEntrance {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .zone-item:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--shadow-lg), 0 0 20px var(--accent-glow);
      border-color: var(--accent-color);
      background-color: var(--bg-surface-hover);
    }

    .zone-item img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      background-color: var(--bg-surface-hover);
      transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    }
    
    .zone-item:hover img {
      transform: scale(1.1);
    }

    .zone-info {
      padding: 1.25rem;
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(10px);
      z-index: 1;
      border-top: 1px solid var(--border-color);
    }

    .zone-item button {
      background: none;
      border: none;
      color: var(--text-primary);
      font-family: inherit;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      text-align: center;
      width: 100%;
      padding: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color 0.3s ease;
    }

    .zone-item:hover button {
      color: var(--accent-color);
    }

    /* Zone Viewer (Modal) */
    #zoneViewer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg-body);
      z-index: 1000;
      display: none;
      flex-direction: column;
      animation: viewerIn 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }

    @keyframes viewerIn {
      from { opacity: 0; transform: scale(1.05); }
      to { opacity: 1; transform: scale(1); }
    }

    .zone-header {
      height: 80px;
      background-color: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 3rem;
    }

    .zone-title h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    .zone-title a {
      font-size: 0.95rem;
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 600;
    }

    .zone-controls {
      display: flex;
      gap: 1rem;
    }

    .zone-controls button {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .zone-controls button:hover {
      background: var(--bg-surface-hover);
      border-color: var(--text-secondary);
      transform: translateY(-1px);
    }

    .zone-controls button.primary-action {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
    }
    
    .zone-controls button.primary-action:hover {
      background: var(--accent-hover);
      box-shadow: 0 0 15px var(--accent-glow);
    }

    #zoneFrame {
      flex-grow: 1;
      border: none;
      width: 100%;
      height: 100%;
      background: #000;
    }

    /* Popup */
    #popupOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(12px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .popup {
      background-color: var(--bg-surface);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      width: 90%;
      max-width: 520px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      animation: popupIn 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }

    @keyframes popupIn {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .popup-header {
      padding: 1.75rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #popupTitle {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    #popupClose {
      background: var(--bg-surface-hover);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      font-size: 1.25rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    #popupClose:hover {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
      transform: rotate(90deg);
    }

    #popupBody {
      padding: 2rem;
      overflow-y: auto;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    #popupBody input[type="text"], 
    #popupBody input[type="file"] {
      width: 100%;
      padding: 1rem;
      margin-bottom: 1.25rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background-color: var(--bg-body);
      color: var(--text-primary);
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    #popupBody input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .settings-btn {
      width: 100%;
      padding: 1rem;
      background-color: var(--bg-surface-hover);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
      text-align: left;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .settings-btn:hover {
      background-color: var(--border-color);
      border-color: var(--accent-color);
      transform: translateX(4px);
    }

    #dontClickMe {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      color: white;
      border: none;
      padding: 0.85rem 1.5rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    #dontClickMe:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
      filter: brightness(1.1);
    }

    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }

    .discombobulate {
      animation: shake 0.1s infinite;
      background-color: #ff0000 !important;
      filter: invert(1) contrast(200%);
    }

    #discombobulateOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: transparent;
      z-index: 10000;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    #discombobulateImg {
      width: 80%;
      height: 80%;
      object-fit: contain;
      animation: shake 0.1s infinite;
    }

    /* Footer */
    footer {
      background-color: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--glass-border);
      padding: 3rem;
      margin-top: auto;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 3rem;
      flex-wrap: wrap;
    }

    .footer-links a, .footer-links label {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .footer-links a:hover, .footer-links label:hover {
      color: var(--accent-color);
      transform: translateY(-2px);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        padding: 1.5rem;
        gap: 1.5rem;
      }
      
      header {
        height: auto;
        position: relative;
      }

      .controls-wrapper {
        width: 100%;
        flex-direction: column;
        gap: 1rem;
      }

      .search-container { width: 100%; }
      #sortOptions { width: 100%; }
      #settings { width: 100%; }
      #dontClickMe { width: 100%; }

      #container, #favorites-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1.25rem;
      }
      
      .zone-item button {
        font-size: 0.9rem;
      }

      main { padding: 2rem 1.5rem; }
    }

    /* Favorites Section */
    #favorites-section {
      margin-bottom: 4rem;
      display: none;
    }

    .favorites-header {
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: -0.03em;
      color: var(--text-primary);
      border-bottom: 2px solid var(--accent-color);
      padding-bottom: 1rem;
      margin-bottom: 2rem;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .favorites-header::before {
      content: "‚òÖ";
      color: var(--accent-color);
    }

    #favorites-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 2rem;
      width: 100%;
    }

    @media (min-width: 1600px) {
      #favorites-grid { grid-template-columns: repeat(8, 1fr); }
    }
    @media (min-width: 1200px) and (max-width: 1599px) {
      #favorites-grid { grid-template-columns: repeat(6, 1fr); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="#" class="logo" onclick="location.reload(); return false;">
        gn-math <span>Arcade</span>
      </a>
      <div class="controls-wrapper">
        <div class="search-container">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input type="text" id="searchBar" placeholder="Search games..." oninput="filterZones()">
        </div>
        <select id="sortOptions" onchange="sortZones()">
          <option value="popular">Popular</option>
          <option value="name">Name</option>
          <option value="id">ID</option>
        </select>
        <button id="dontClickMe" onclick="showIP()">don‚Äôt click me</button>
        <button id="settings" title="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          Settings
        </button>
      </div>
    </div>
  </header>

  <main>
    <div id="favorites-section">
      <h2 class="favorites-header">Creator's Favorites</h2>
      <div id="favorites-grid"></div>
    </div>

    <div id="zoneCount">Initializing...</div>
    <div id="container">
      <div style="grid-column: 1/-1; text-align: center; padding: 6rem; color: var(--text-secondary);">
        <div class="loading-spinner" style="width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem;"></div>
        Fetching game library...
      </div>
    </div>
  </main>

  <div id="zoneViewer">
    <div class="zone-header">
      <div class="zone-title">
        <h2 id="zoneName">Game Title</h2>
        <span id="zoneId" style="display:none"></span>
        <a id="zoneAuthor" href="#" target="_blank">Developer</a>
      </div>
      <div class="zone-controls">
        <button onclick="fullscreenZone()">Fullscreen</button>
        <button onclick="aboutBlank()">New Tab</button>
        <button onclick="downloadZone()">Download</button>
        <button class="primary-action" onclick="closeZone()">Close</button>
      </div>
    </div>
    <iframe id="zoneFrame"></iframe>
  </div>

  <div id="popupOverlay">
    <div class="popup">
      <div class="popup-header">
        <h3 id="popupTitle">Title</h3>
        <button id="popupClose" onclick="closePopup()">√ó</button>
      </div>
      <div id="popupBody">Content</div>
    </div>
  </div>

  <footer>
    <div class="footer-links">
      <a href="#" onclick="showContact(); return false;">Contact</a>
      <a href="#" onclick="loadPrivacy(); return false;">Privacy Policy</a>
      <a href="javascript:saveData()">Export Data</a>
      <label for="importData">Import Data</label>
      <input type="file" id="importData" style="display: none;" onchange="loadData(event)">
    </div>
  </footer>

  <div id="discombobulateOverlay">
    <img id="discombobulateImg" src="assets/IMG_1291.jpg" alt="Discombobulate">
  </div>

  <script>
    // Configuration
    const zonesURL = "https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json";
    const coverURL = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
    const htmlURL = "https://cdn.jsdelivr.net/gh/gn-math/html@main";

    // DOM Elements
    const container = document.getElementById('container');
    const favoritesSection = document.getElementById('favorites-section');
    const favoritesGrid = document.getElementById('favorites-grid');
    const zoneViewer = document.getElementById('zoneViewer');
    let zoneFrame = document.getElementById('zoneFrame');
    const searchBar = document.getElementById('searchBar');
    const sortOptions = document.getElementById('sortOptions');
    const zoneCount = document.getElementById('zoneCount');
    
    // State
    let zones = [];
    let searchHistory = [];
    let popularityData = {};
    
    // Creator's Favorites List
    const favoriteNames = [
      "ragdoll archers", 
      "slowroads", 
      "bad parenting", 
      "basket random", 
      "crazy cattle 3d", 
      "bad time simulator", 
      "time shooter 2", 
      "rooftop snipers",
      "escape road"
    ];

    // Initialize
    async function listZones() {
      try {
        zoneCount.textContent = "Fetching library...";
        const response = await fetch(zonesURL + "?t=" + Date.now());
        if (!response.ok) throw new Error(`Server returned ${response.status}`);
        
        zones = await response.json();
        processFavorites();
        fetchPopularity().then(() => sortZones()).catch(() => sortZones());
        
        const search = new URLSearchParams(window.location.search);
        const id = search.get('id');
        if (id) {
          const zone = zones.find(z => String(z.id) === String(id));
          if (zone) openZone(zone);
        }
      } catch (error) {
        console.warn("Fetch failed, loading demo data:", error);
        zones = Array.from({ length: 16 }, (_, i) => ({
          id: i,
          name: `Demo Game ${i + 1}`,
          cover: "", 
          url: "#",
          author: "Demo Author"
        }));
        
        const demoFavorites = zones.slice(0, 8).map((z, i) => ({ ...z, name: favoriteNames[i] || z.name }));
        displayZones(demoFavorites, favoritesGrid);
        favoritesSection.style.display = "block";
        
        displayZones(zones);
        zoneCount.textContent = "Demo Mode (Network Unavailable)";
      }
    }

    function processFavorites() {
      const favorites = favoriteNames.map(name => {
        return zones.find(z => (z.name || "").toLowerCase().includes(name.toLowerCase()));
      }).filter(Boolean);

      if (!favorites.find(f => f.name.toLowerCase().includes("escape road"))) {
          favorites.push({
              id: "escape-road-manual",
              name: "Escape Road",
              cover: "https://play-lh.googleusercontent.com/4rnrsa7D_Yu8dfr3zoPN_cys5cklEsaJJVGk6vbiN_xh_EktJqoiywG9qjEiEbAwpnXqS_luciNNEimyovWvIw",
              url: "https://www.crazygames.com/game/escape-road",
              author: "External"
          });
      }

      if (favorites.length > 0) {
        displayZones(favorites, favoritesGrid);
        favoritesSection.style.display = "block";
      }
    }

    async function fetchPopularity() {
      try {
        const response = await fetch("https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year");
        const data = await response.json();
        data.forEach(file => {
          const idMatch = file.name.match(/\/(\d+)\.html$/);
          if (idMatch) {
            const id = parseInt(idMatch[1]);
            popularityData[id] = file.hits.total;
          }
        });
      } catch (err) {
        console.warn("Popularity data unavailable", err);
      }
    }

    function sortZones() {
      const sortBy = sortOptions.value;
      if (sortBy === 'name') zones.sort((a, b) => a.name.localeCompare(b.name));
      else if (sortBy === 'id') zones.sort((a, b) => a.id - b.id);
      else if (sortBy === 'popular') zones.sort((a, b) => (popularityData[b.id] || 0) - (popularityData[a.id] || 0));
      zones.sort((a, b) => (a.id === -1 ? -1 : b.id === -1 ? 1 : 0));
      displayZones(zones);
    }

    function displayZones(list, targetContainer = container) {
      targetContainer.innerHTML = "";
      
      if (list.length === 0) {
        if (targetContainer === container) {
            targetContainer.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-secondary); font-weight: 600;">No games found matching your criteria.</div>`;
            zoneCount.textContent = "0 Games";
        }
        return;
      }

      const fragment = document.createDocumentFragment();
      
      list.forEach((file, index) => {
        const zoneItem = document.createElement("div");
        zoneItem.className = "zone-item";
        zoneItem.style.animationDelay = `${index * 0.05}s`;
        zoneItem.onclick = () => openZone(file);
        zoneItem.title = file.name;

        const img = document.createElement("img");
        img.loading = "lazy";
        img.src = file.cover.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        img.alt = file.name;
        img.onerror = function() { 
          this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgZmlsbD0iIzMzNDE1NSI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIC8+PHRleHQgeD0iNTAiIHk9IjUwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk0YTNiOCIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='; 
          this.style.opacity = "0.5";
        };
        zoneItem.appendChild(img);

        const info = document.createElement("div");
        info.className = "zone-info";
        const button = document.createElement("button");
        button.textContent = file.name;
        button.onclick = (ev) => { ev.stopPropagation(); openZone(file); };
        info.appendChild(button);
        zoneItem.appendChild(info);

        fragment.appendChild(zoneItem);
      });

      targetContainer.appendChild(fragment);
      if (targetContainer === container) {
        zoneCount.textContent = `${list.length} Games Available`;
      }
    }

    function filterZones() {
      const q = (searchBar.value || "").toLowerCase();
      if (q.trim().length > 0 && !searchHistory.includes(q)) {
        searchHistory.push(q);
      }
      if (q.length > 0) {
        favoritesSection.style.display = "none";
      } else {
        if (favoritesGrid && favoritesGrid.children.length > 0) {
          favoritesSection.style.display = "block";
        }
      }
      const filtered = zones.filter(z => (z.name || "").toLowerCase().includes(q));
      displayZones(filtered);
    }

    async function openZone(file) {
      try {
        if (!file) return;
        if (file.url && file.url.startsWith("http")) {
          window.open(file.url, "_blank");
          return;
        }
        const url = file.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        zoneViewer.style.display = "flex";
        document.getElementById('zoneName').textContent = file.name || "Loading...";
        document.getElementById('zoneId').textContent = file.id || "";
        document.getElementById('zoneAuthor').textContent = file.author ? "by " + file.author : "";
        if (file.authorLink) document.getElementById('zoneAuthor').href = file.authorLink;
        else document.getElementById('zoneAuthor').removeAttribute('href');

        const response = await fetch(url + "?t=" + Date.now());
        if (!response.ok) throw new Error("Failed to load game content");
        const html = await response.text();

        if (!zoneFrame || !zoneViewer.contains(zoneFrame)) {
          zoneFrame = document.createElement("iframe");
          zoneFrame.id = "zoneFrame";
          zoneViewer.appendChild(zoneFrame);
        }

        try {
          const doc = zoneFrame.contentDocument || zoneFrame.contentWindow.document;
          doc.open();
          doc.write(html);
          doc.close();
        } catch (e) {
          window.open(url, "_blank");
          closeZone();
        }
      } catch (err) {
        alert("Failed to load game: " + err.message);
        closeZone();
      }
    }

    function closeZone() {
      zoneViewer.style.display = "none";
      if (zoneFrame && zoneViewer.contains(zoneFrame)) {
        zoneViewer.removeChild(zoneFrame);
      }
      zoneFrame = document.createElement("iframe");
      zoneFrame.id = "zoneFrame";
    }

    async function aboutBlank() {
      const id = document.getElementById('zoneId').textContent;
      const zone = zones.find(z => String(z.id) === String(id));
      if (zone) {
        const url = zone.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        const win = window.open('about:blank', '_blank');
        if (!win) return;
        try {
          const response = await fetch(url + "?t=" + Date.now());
          const html = await response.text();
          win.document.open();
          win.document.write(html);
          win.document.close();
        } catch (e) {
          win.location.href = url;
        }
      }
    }

    async function downloadZone() {
      const id = document.getElementById('zoneId').textContent;
      const zone = zones.find(z => String(z.id) === String(id));
      if (!zone) return;
      try {
        const url = zone.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        const res = await fetch(url);
        const text = await res.text();
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = (zone.name || "game") + ".html";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      } catch (e) { alert("Download failed"); }
    }

    function fullscreenZone() {
      if (zoneFrame) {
        if (zoneFrame.requestFullscreen) zoneFrame.requestFullscreen();
        else if (zoneFrame.webkitRequestFullscreen) zoneFrame.webkitRequestFullscreen();
      }
    }

    function saveData() {
      const data = JSON.stringify(localStorage) + "\n\n|\n\n" + document.cookie;
      const blob = new Blob([data], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `gn-math-backup-${Date.now()}.data`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function loadData(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        const parts = content.split("\n\n|\n\n");
        try {
          const parsed = JSON.parse(parts[0]);
          for (let k in parsed) localStorage.setItem(k, parsed[k]);
          if (parts[1]) parts[1].split("; ").forEach(c => document.cookie = c);
          alert("Data imported successfully. Reloading...");
          location.reload();
        } catch (err) { alert("Invalid data file."); }
      };
      reader.readAsText(file);
    }

    function toggleTheme() {
      document.body.classList.toggle("light-mode");
    }

    function cloakIcon(url) {
      let link = document.querySelector("link[rel~='icon']");
      if (!link) {
        link = document.createElement('link');
        link.rel = 'icon';
        document.head.appendChild(link);
      }
      link.href = url || 'favicon.ico';
    }

    function cloakName(name) {
      document.title = name || 'gn-math';
    }

    function tabCloak() {
      closePopup();
      showPopup("Tab Cloak", `
        <label style="font-weight:600; display:block; margin-bottom:0.5rem">Tab Title</label>
        <input type="text" placeholder="Google Drive" oninput="cloakName(this.value)">
        <label style="font-weight:600; display:block; margin-bottom:0.5rem; margin-top:1rem">Tab Icon URL</label>
        <input type="text" placeholder="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png" oninput="cloakIcon(this.value)">
      `);
    }

    function showPopup(title, htmlContent) {
      document.getElementById('popupTitle').textContent = title;
      document.getElementById('popupBody').innerHTML = htmlContent;
      document.getElementById('popupOverlay').style.display = "flex";
    }

    function closePopup() {
      document.getElementById('popupOverlay').style.display = "none";
    }

    document.getElementById('settings').addEventListener('click', () => {
      showPopup("Settings", `
        <button class="settings-btn" onclick="toggleTheme()">Toggle Light/Dark Mode <span>üåì</span></button>
        <button class="settings-btn" onclick="tabCloak()">Tab Cloak <span>üé≠</span></button>
      `);
    });

    function showContact() {
      showPopup("Contact", `<p>Join our Discord: <a href="https://discord.gg/NAFw4ykZ7n" target="_blank" style="color:var(--accent-color)">discord.gg/NAFw4ykZ7n</a></p>`);
    }

    function loadPrivacy() {
      showPopup("Privacy Policy", `<div style="line-height:1.6"><p>This site loads content from external CDNs (jsdelivr). Please refer to their privacy policies.</p><p>Local data (saves) are stored in your browser's LocalStorage.</p></div>`);
    }

    async function showIP() {
      const btn = document.getElementById('dontClickMe');
      const originalText = btn.textContent;
      btn.textContent = "CRITICAL ERROR";
      btn.disabled = true;
      const siren = new Audio('https://www.soundjay.com/misc/sounds/siren-1.mp3');
      siren.volume = 1.0;
      siren.loop = true;
      siren.play().catch(e => console.warn("Audio playback failed:", e));
      
      const overlay = document.getElementById('discombobulateOverlay');
      overlay.style.display = "flex";
      document.body.classList.add('discombobulate');
      
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        let historyText = searchHistory.length > 0 ? "\n\nSearch History Leaked:\n" + searchHistory.join(", ") : "\n\nNo search history found... yet.";
        
        setTimeout(() => {
          document.body.classList.remove('discombobulate');
          overlay.style.display = "none";
          siren.pause();
          alert("‚ö†Ô∏è SYSTEM COMPROMISED ‚ö†Ô∏è\n\nYour IP address is: " + data.ip + historyText + "\n\nDevice status: DISCOMBOBULATED");
          btn.textContent = originalText;
          btn.disabled = false;
        }, 5000); // Lasts 5 seconds now
      } catch (error) {
        alert("Failed to fetch IP address. But the discombobulation is real!");
        document.body.classList.remove('discombobulate');
        overlay.style.display = "none";
        siren.pause();
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    document.getElementById('importData').addEventListener('change', loadData);
    listZones();
  </script>
</body>
</html>
