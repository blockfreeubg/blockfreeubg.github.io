<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CDNSearch</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --rainbow: linear-gradient(135deg, #ff3b6b, #ff6b9d, #9d5fd8, #4fb3e8, #4be89f, #e8c84b, #ff8c4b);
        }

        body,
        html {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, sans-serif;
            background: #1c1b22;
            color: #fbfbfe;
            height: 100%;
            overflow-x: hidden;
        }

        #tabbar {
            display: flex;
            gap: 8px;
            padding: 8px 9px 0 9px;
            background: #1c1b22;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            max-width: 100vw;
            overflow-x: auto;
        }

        .tab-close {
            background: transparent;
            border: none;
            color: #8f8f9d;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            margin-left: auto;
            flex-shrink: 0;
            opacity: 1;
            transition: all 0.15s;
        }

        .tab:hover .tab-close {
            opacity: 1;
        }

        .tab-close:hover {
            background: #ff3b6b;
            color: #fff;
        }

        .tab-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .tab-content span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .tab {
            position: relative;
            padding: 12px;
            background: #2b2a33;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 400;
            font-size: 14px;
            color: #cfcfd8;
            border: none;
            flex: 1 1 180px;
            min-width: 100px;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .tab.lowercase span {
            position: relative;
            top: -2px;
        }

        .tab::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 8px 8px 0 0;
            padding: 2px;
            background: linear-gradient(135deg, #ff3b6b, #ff6b9d, #9d5fd8, #4fb3e8, #4be89f, #e8c84b, #ff8c4b);
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .tab:hover {
            background: #3a3a44;
        }

        .tab.active {
            background: #42414d;
            font-weight: 500;
            border-color: #52525e;
            border-bottom-color: #1c1b22;
            color: #fbfbfe;
        }

        .tab.add-tab {
            background: #2b2a33;
            padding: 12px;
            flex: 0 0 50px;
            min-width: 50px;
            max-width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab.add-tab:hover {
            background: #52525e;
        }

        .tab i.fa-circle {
            font-size: 17px;
            color: #fff;
            margin-right: 1px;
        }

        .tab i.fa-plus {
            font-size: 18px;
        }

        #topbar {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #2b2a33;
            padding: 0px 12px 10px 12px;
            padding-top: 14px;
            position: fixed;
            top: 49px;
            left: 0;
            right: 0;
            z-index: 999;
            border-bottom: 2px solid #3e3d46;
            border-top: 2px solid #3e3d46;
            border-radius: 10px 10px 0 0;
            max-width: 100vw;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: #fbfbfe;
            font-size: 18px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background 0.15s;
        }

        .nav-btn:hover {
            background: #42414d;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn:disabled:hover {
            background: transparent;
        }

        #addressbar {
            display: flex;
            align-items: center;
            flex: 1;
            background: #42414d;
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: -4px;
            border: 2px solid #52525e;
            transition: border-color 0.2s;
            min-width: 0;
        }

        #addressbar:focus-within {
            border-color: #c9a3e8;
        }

        #addressbar i {
            color: #c9a3e8;
            margin-right: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: color 0.2s;
        }

        #addressbar i:hover {
            color: #d4b5ed;
        }

        #addressbar input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 14px;
            background: transparent;
            color: #fbfbfe;
            font-family: inherit;
            min-width: 0;
        }

        #addressbar input::placeholder {
            color: #8f8f9d;
        }

        .toolbar-btn {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #fbfbfe;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background 0.15s;
        }

        .toolbar-btn:hover {
            background: #42414d;
        }

        #content {
            margin-top: 100px;
            padding: 24px;
            min-height: calc(100vh - 100px);
            overflow-y: auto;
            background: #1c1b22;
            max-width: 100vw;
            box-sizing: border-box;
        }

        .home {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 200px);
            max-width: 800px;
            margin: 0 auto;
            padding-top: 50px;
            overflow: hidden;
        }

        .logo-badge::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 2px;
            background: linear-gradient(135deg, #ff3b6b, #ff6b9d, #9d5fd8, #4fb3e8, #4be89f, #e8c84b, #ff8c4b);
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .logo-container {
            position: relative;
            display: flex;
            align-items: center;
            margin: 0;
        }

        .logo-badge {
            position: relative;
            background: #2b2a33;
            border-radius: 12px;
            padding: 4px 12px;
            margin-right: 8px;
            font-size: 32px;
            font-weight: 600;
            letter-spacing: -0.5px;
            margin-bottom: 2px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo {
            font-size: 62px;
            font-weight: 600;
            letter-spacing: -1px;
            color: #fbfbfe;
            line-height: 1;
        }

        .logo-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 26px;
            flex-wrap: wrap;
        }

        .byline {
            font-size: 16px;
            color: #8f8f9d;
            font-weight: 400;
            margin-bottom: -26px;
            margin-left: -10px;
        }
        
        .searchbox .search-icon-btn {
            background: transparent;
            border: none;
            color: #8f8f9d;
            cursor: pointer;
            padding: 0;
            font-size: 16px;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .searchbox .search-icon-btn:hover {
            color: #fff;
        }

        .searchbox {
            margin: 0 auto;
            display: flex;
            align-items: center;
            border-radius: 8px;
            padding: 12px 16px;
            background: #42414d;
            border: 2px solid #52525e;
            transition: all 0.2s;
            width: 100%;
            max-width: 650px;
        }

        .searchbox:focus-within {
            border-color: #c9a3e8;
        }

        .searchbox i {
            color: #8f8f9d;
            margin-right: 12px;
        }

        .searchbox input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 15px;
            background: transparent;
            color: #fbfbfe;
            font-family: inherit;
        }

        .searchbox input::placeholder {
            color: #8f8f9d;
        }

        .quick-shortcuts {
            display: flex;
            gap: 16px;
            margin-top: 28px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .shortcut {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 0px 12px 0px;
            background: #2b2a33;
            border: 2px solid #3e3d46;
            border-radius: 12px;
            width: 120px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: #fbfbfe;
        }

        .shortcut:hover {
            border-color: #c9a3e8;
            background: #3a3a44;
            transform: translateY(-2px);
        }

        .shortcut-icon {
            font-size: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: #42414d;
        }

        .shortcut-label {
            font-size: 14px;
            font-weight: 500;
            color: #cfcfd8;
        }

        .shortcut-website .shortcut-icon {
            background: #6e5494;
        }

        .shortcut-github .shortcut-icon {
            background: #6e5494;
        }

        .shortcut-issues .shortcut-icon {
            background: #6e5494
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
            margin-top: 20px;
            max-width: 100%;
        }

        @media (max-width: 1200px) {
            .results-grid {
                grid-template-columns: 1fr 280px;
                gap: 20px;
            }
        }

        @media (max-width: 1000px) {
            .results-grid {
                grid-template-columns: 1fr;
            }

            .image-column {
                display: none;
            }
        }

        .results-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-width: 0;
        }

        .image-column {
            position: sticky;
            top: 120px;
            height: fit-content;
            min-width: 0;
            overflow: visible;
        }

        .result-container {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .result-buttons {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
            margin-top: 0;
        }

        .result-bookmark,
        .result-copy {
            background: transparent;
            border: none;
            color: #8f8f9d;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            font-size: 20px;
            transition: all 0.15s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-bookmark:hover {
            background: #2b2a33;
            color: #c9a3e8;
        }

        .result-copy:hover {
            background: #2b2a33;
            color: #c9a3e8;
        }

        .result-copy.copied {
            color: #e8c84b !important;
        }

        .result-bookmark.bookmarked {
            color: #e8c84b;
        }

        .result {
            position: relative;
            flex: 1;
            padding: 16px;
            background: #2b2a33;
            border-radius: 7px;
            border: 2px solid transparent;
            transition: all 0.2s;
            min-width: 0;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .result::before {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: 7px;
            padding: 2px;
            background: linear-gradient(135deg, #ff3b6b, #ff6b9d, #9d5fd8, #4fb3e8, #4be89f, #e8c84b, #ff8c4b);
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .result:hover::before {
            opacity: 1;
        }

        .result:hover {
            border-color: transparent;
        }

        .result-header {
            font-size: 12px;
            color: #8f8f9d;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-wrap: wrap;
        }

        .result-header .bullet {
            font-size: 6px;
            flex-shrink: 0;
        }

        .result a {
            color: #c9a3e8;
            font-size: 17px;
            text-decoration: none;
            font-weight: 500;
            line-height: 1.4;
            display: block;
            margin-bottom: 8px;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .result a:hover {
            text-decoration: underline;
            color: #d4b5ed;
        }

        .snippet {
            font-size: 13px;
            color: #cfcfd8;
            line-height: 1.5;
            max-height: 8.25em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .image-result,
        .definition-result {
            position: relative;
            background: #2b2a33;
            border-radius: 7px;
            border: 2px solid #3e3d46;
            overflow: hidden;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .image-result::before,
        .definition-result::before {
            content: "";
            position: absolute;
            inset: -2px;
            border-radius: 7px;
            padding: 2px;
            background: linear-gradient(135deg, #ff3b6b, #ff6b9d, #9d5fd8, #4fb3e8, #4be89f, #e8c84b, #ff8c4b);
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .image-result:hover::before,
        .definition-result:hover::before {
            opacity: 1;
        }

        .image-result:hover,
        .definition-result:hover {
            border-color: transparent;
        }

        .image-preview {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #1c1b22;
            display: block;
            cursor: pointer;
        }

        .image-info,
        .definition-info {
            padding: 12px;
        }

        .image-title {
            color: #c9a3e8;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.4;
        }

        .definition-title {
            color: #c9a3e8;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .word {
            font-size: 18px;
            font-weight: 600;
        }

        .part-of-speech {
            background: #42414d;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: #8f8f9d;
        }

        .definition-text {
            font-size: 13px;
            color: #cfcfd8;
            line-height: 1.5;
            margin-bottom: 8px;
            max-height: 8em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 6;
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
        }

        .definition-example {
            font-size: 12px;
            color: #8f8f9d;
            font-style: italic;
            margin: 6px 0;
            padding-left: 10px;
            border-left: 2px solid #52525e;
        }

        .definition-synonyms {
            font-size: 12px;
            color: #8f8f9d;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #3e3d46;
        }

        .synonym-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .synonym-tag {
            background: #42414d;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            color: #cfcfd8;
        }

        .phonetic {
            font-size: 12px;
            color: #8f8f9d;
            font-style: italic;
            margin-bottom: 8px;
        }

        .image-stats {
            font-size: 11px;
            color: #8f8f9d;
            margin-bottom: 8px;
        }

        .image-source,
        .definition-source {
            font-size: 10px;
            color: #a0a0aa;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .image-source:hover,
        .definition-source:hover {
            color: #c9a3e8;
        }

        .image-source-link,
        .definition-source-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            gap: 4px;
            width: 100%;
        }

        .image-source-link:hover,
        .definition-source-link:hover {
            text-decoration: underline;
        }

        .no-images,
        .no-definition {
            text-align: center;
            padding: 40px 20px;
            color: #8f8f9d;
            background: #2b2a33;
            border-radius: 8px;
            border: 2px dashed #3e3d46;
            margin-bottom: 16px;
        }

        .no-images i,
        .no-definition i {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .panel {
            display: none;
            position: fixed;
            top: 119px;
            background: #2b2a33;
            border-radius: 8px;
            padding: 0;
            width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid #3e3d46;
            z-index: 1001;
            font-size: 14px;
            max-height: calc(100vh - 127px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #settingsPanel,
        #historyPanel,
        #bookmarksPanel,
        #filtersPanel,
        #notesPanel {
            right: 8px;
            left: auto;
        }

        #searchInfoPanel {
            left: 8px;
            right: auto;
        }

        .panel-header {
            padding: 20px 20px 16px 20px;
            border-bottom: 1px solid #3e3d46;
            background: #2b2a33;
            flex-shrink: 0;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #fbfbfe;
        }

        .panel-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .panel-footer {
            padding: 6px 20px 16px 20px;
            border-top: 1px solid #3e3d46;
            background: #2b2a33;
            flex-shrink: 0;
        }

        .panel-content::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: #1c1b22;
            border-radius: 4px;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: #52525e;
            border-radius: 4px;
        }

        .history-item,
        .bookmark-item {
            padding: 12px;
            background: #1c1b22;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.15s;
            border: 1px solid #3e3d46;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .history-item:hover,
        .bookmark-item:hover {
            background: #2b2a33;
            border-color: #52525e;
        }

        .history-content,
        .bookmark-content {
            flex: 1;
            min-width: 0;
        }

        .history-query,
        .bookmark-title {
            color: #c9a3e8;
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-time,
        .bookmark-url {
            font-size: 12px;
            color: #8f8f9d;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: #8f8f9d;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.15s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background: #ff3b6b;
            color: #fff;
        }

        .clear-all-btn {
            width: 100%;
            padding: 10px;
            background: #ff3b6b;
            border: 1px solid #ff3b6b;
            color: #fbfbfe;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            transition: all 0.15s;
        }

        .clear-all-btn:hover {
            background: #ff5c85;
            border-color: #ff5c85;
        }

        #settingsPanel label {
            display: block;
            margin: 16px 0;
            color: #fbfbfe;
            font-weight: 500;
        }

        .help {
            font-size: 12px;
            color: #8f8f9d;
            margin-top: 4px;
            font-weight: 400;
            line-height: 1.4;
        }

        #settingsPanel input[type=number],
        #settingsPanel input[type=range],
        #settingsPanel input[type=text] {
            width: 100%;
            margin-top: 8px;
            background: #42414d;
            border: 1px solid #52525e;
            color: #fbfbfe;
            padding: 8px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
        }

        #settingsPanel input[type=range] {
            padding: 0;
            height: 6px;
            accent-color: #c9a3e8;
        }

        #settingsPanel input:disabled {
            background: #2b2a33;
            color: #5b5b66;
            cursor: not-allowed;
            opacity: 0.5;
        }

        input[type=checkbox] {
            accent-color: #c9a3e8;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        input[type=checkbox]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group label {
            margin: 0;
            font-weight: 400;
            cursor: pointer;
        }

.status {
    position: relative;
    font-size: 13px;
    color: #8f8f9d;
    padding: 12px;
    background: #2b2a33;
    border-radius: 8px;
    border: 2px solid #3e3d46;
    flex: 1;
    min-width: 0;
}

        .section-divider {
            height: 1px;
            background: #3e3d46;
            margin: 20px 0;
        }

        .range-value {
            display: inline-block;
            min-width: 40px;
            text-align: right;
            color: #c9a3e8;
            font-weight: 600;
            margin-left: -20px;
        }

        .disabled-section {
            opacity: 0.5;
            pointer-events: none;
        }

        .filter-label {
            display: block;
            margin: 12px 0;
            color: #fbfbfe;
            font-weight: 400;
            font-size: 14px;
        }

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin: 24px 0;
    flex-wrap: wrap;
    width: 100%;
}

        .page-btn {
            position: relative;
            background: #2b2a33;
            border: 2px solid #3e3d46;
            color: #fbfbfe;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 40px;
        }

        .page-btn:hover:not(:disabled) {
            background: #42414d;
            border-color: #52525e;
        }

        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: #c9a3e8;
            border-color: #c9a3e8;
            color: #1c1b22;
            font-weight: 600;
            pointer-events: none;
        }

        .page-btn.active:hover {
            background: #c9a3e8;
            border-color: #c9a3e8;
            color: #1c1b22;
        }

        .page-info {
            color: #8f8f9d;
            font-size: 13px;
            padding: 0 12px;
        }

        #filtersPanel input[type=text] {
            width: 100%;
            margin-top: 8px;
            background: #42414d;
            border: 1px solid #52525e;
            color: #fbfbfe;
            padding: 8px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
        }

        .filter-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 12px 0;
        }

        .filter-preset-btn {
            padding: 10px 8px;
            background: #42414d;
            border: 1px solid #52525e;
            color: #fbfbfe;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
            text-align: center;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .filter-preset-btn:hover {
            background: #52525e;
            border-color: #52525e;
        }

        .filter-preset-btn.active {
            background: #c9a3e8;
            border-color: #c9a3e8;
            color: #1c1b22;
            font-weight: 600;
        }

        .note-item {
            padding: 12px;
            background: #1c1b22;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #3e3d46;
        }

        .note-title {
            color: #c9a3e8;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .note-content {
            font-size: 13px;
            color: #cfcfd8;
            line-height: 1.5;
            margin-bottom: 4px;
        }

        .note-time {
            font-size: 11px;
            color: #8f8f9d;
        }

        .note-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .note-btn {
            background: #42414d;
            border: 1px solid #52525e;
            color: #fbfbfe;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s;
        }

        .note-btn:hover {
            background: #52525e;
        }

        #noteInput {
            width: 100%;
            min-height: 80px;
            margin: 8px 0;
            background: #42414d;
            border: 1px solid #52525e;
            color: #fbfbfe;
            padding: 8px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .export-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #3e3d46;
        }

        .export-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .export-btn {
            flex: 1;
            padding: 10px;
            background: #9d5fd8;
            border: none;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .export-btn:hover {
            background: #c9a3e8;
        }

        .import-btn {
            flex: 1;
            padding: 10px;
            background: #e8c84b;
            border: none;
            color: #1c1b22;
            border-radius: 6px;
            cursor: button;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .import-btn:hover {
            background: #f0d56e;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #e8c84b;
            color: #1c1b22;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .file-input-label:hover {
            background: #f0d56e;
        }

        .import-options {
            margin: 12px 0;
            padding: 12px;
            background: #1c1b22;
            border-radius: 6px;
            border: 1px solid #3e3d46;
        }

        .import-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .import-option label {
            margin: 0;
            font-weight: 400;
            cursor: pointer;
        }

        .import-help {
            font-size: 11px;
            color: #8f8f9d;
            margin-top: 4px;
            line-height: 1.4;
        }

        .api-status {
            font-size: 11px;
            color: #8f8f9d;
            margin-top: 4px;
            padding: 4px 8px;
            background: #1c1b22;
            border-radius: 4px;
            border: 1px solid #3e3d46;
        }

        .search-info-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #3e3d46;
        }

        .search-info-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .search-info-label {
            font-size: 12px;
            color: #8f8f9d;
            margin-bottom: 4px;
        }

        .search-info-value {
            font-size: 14px;
            color: #fbfbfe;
            font-weight: 500;
        }

        .search-info-highlight {
            color: #c9a3e8;
            font-weight: 600;
        }

        .import-export-container {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .import-export-container .file-input-label,
        .import-export-container .export-btn {
            flex: 1;
            margin: 0;
        }

        .notes-section-divider {
            height: 1px;
            background: #3e3d46;
            margin: 20px 0;
        }

        .notes-section-divider.hidden {
            display: none;
        }

        
        .results-view-container {
            display: flex;
            gap: 24px;
            margin-top: 20px;
            max-width: 100%;
        }

        .main-results-column {
            flex: 1;
            min-width: 0;
        }

        .side-column {
            width: 320px;
            min-width: 320px;
        }

        @media (max-width: 1200px) {
            .side-column {
                width: 280px;
                min-width: 280px;
            }
        }

        @media (max-width: 1000px) {
            .results-view-container {
                flex-direction: column;
            }
            
            .side-column {
                width: 100%;
                min-width: 100%;
            }
        }

        
        .grid-view-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .grid-slot {
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }

        .grid-slot .result {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #2b2a33;
            border-radius: 7px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .grid-slot .result:hover {
            border-color: #c9a3e8;
        }

        .grid-slot .result-header {
            font-size: 11px;
            color: #8f8f9d;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grid-slot .result-header-buttons {
            display: flex;
            gap: 4px;
        }

        .grid-slot .result-bookmark,
        .grid-slot .result-copy {
            background: transparent;
            border: none;
            color: #8f8f9d;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 14px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .grid-slot .result-bookmark:hover {
            background: #2b2a33;
            color: #c9a3e8;
        }

        .grid-slot .result-copy:hover {
            background: #2b2a33;
            color: #c9a3e8;
        }

        .grid-slot .result-bookmark.bookmarked {
            color: #e8c84b;
        }

        .grid-slot .result-copy.copied {
            color: #e8c84b !important;
        }

        .grid-slot .result a {
            color: #c9a3e8;
            font-size: 15px;
            text-decoration: none;
            font-weight: 500;
            line-height: 1.4;
            display: block;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .grid-slot .result a:hover {
            text-decoration: underline;
        }

        .grid-slot .snippet {
            font-size: 13px;
            color: #cfcfd8;
            line-height: 1.5;
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            margin-bottom: 8px;
        }

        .grid-slot .image-result,
        .grid-slot .definition-result {
            height: 100%;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
        }
.status-area-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 16px;
    width: 100%;
}
        .grid-slot .image-preview {
            height: 120px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .grid-slot .image-info,
        .grid-slot .definition-info {
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .grid-slot .definition-text {
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }

        .grid-slot .no-images,
        .grid-slot .no-definition {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            flex: 1;
        }

        @media (max-width: 1200px) {
            .grid-view-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .grid-view-container {
                grid-template-columns: 1fr;
            }
        }

.view-toggle-container {
    display: flex;
    align-items: center;
    margin: 0;
    min-width: fit-content;
    position: relative; 
    z-index: 10; 
}


#toggleGridView {
    background: #c9a3e8;
    border-color: #c9a3e8;
    color: #1c1b22;
    font-weight: 600;
    padding: 10px 16px;
    height: 40px;
    font-size: 14px !important; 
    position: relative;
    z-index: 11;
    cursor: pointer !important;
    min-width: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

#toggleGridView:hover {
    background: #d4b5ed;
    border-color: #d4b5ed;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(201, 163, 232, 0.3);
}

#toggleGridView.active {
    background: #c9a3e8;
    border-color: #c9a3e8;
    color: #1c1b22;
    font-weight: 600;
}

#toggleGridView.active:hover {
    background: #c9a3e8;
    border-color: #c9a3e8;
    transform: none;
    box-shadow: none;
}


#toggleGridView span {
    font-size: 14px;
    font-weight: 600;
}


.view-toggle-container {
    display: flex;
    align-items: center;
    margin: 0;
    min-width: fit-content;
    position: relative;
    z-index: 10;
}

.view-toggle-container #toggleGridView {
    margin: 0 !important;
}

        
        .side-column-content {
            position: sticky;
            top: 120px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .image-result,
        .definition-result,
        .no-images,
        .no-definition {
            margin-bottom: 0;
            height: auto;
        }

        .no-images,
        .no-definition {
            min-height: 200px;
        }

        .image-preview {
            height: 180px;
        }

.status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    width: 100%;
}

.status-info {
    flex: 1;
    min-width: 0;
}

.page-info-right {
    color: #c9a3e8;
    font-weight: 600;
    white-space: nowrap;
}
        
.grid-slot {
    min-height: 220px !important;
    height: auto !important;
    display: flex;
    flex-direction: column;
}

.grid-slot .result,
.grid-slot .image-result,
.grid-slot .definition-result,
.grid-slot .no-images,
.grid-slot .no-definition {
    min-height: auto !important;
    height: auto !important;
    flex: 1;
    display: flex;
    flex-direction: column;
}


.grid-slot .result {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.grid-slot .snippet {
    flex: 1;
    overflow: hidden;
}

.grid-slot .image-info,
.grid-slot .definition-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.grid-slot .definition-text {
    flex: 1;
    overflow: hidden;
}


.grid-slot .image-preview {
    height: 139px !important;
    max-height: 139px !important;
    min-height: 139px !important;
    object-fit: cover;
    flex-shrink: 0;
}

    </style>
</head>

<body>

    <div id="tabbar">
        <div class="tab active" data-tab="1">
            <div class="tab-content">
                <i class="fa-solid fa-globe"></i>
                <span>New Tab</span>
            </div>
            <button class="tab-close" title="Close tab"><i class="fa fa-times"></i></button>
        </div>
        <div class="tab add-tab" title="New Tab"><i class="fa fa-plus"></i></div>
    </div>

    <div id="topbar">
        <button class="nav-btn" id="homeBtn" title="Home"><i class="fa fa-home"></i></button>
        <button class="nav-btn" id="backBtn" title="Back"><i class="fa fa-arrow-left"></i></button>
        <button class="nav-btn" id="forwardBtn" title="Forward"><i class="fa fa-arrow-right"></i></button>
        <button class="nav-btn" id="refreshBtn" title="Refresh"><i class="fa fa-rotate-right"></i></button>

        <div id="addressbar">
            <i class="fa fa-lock" id="lockBtn" title="Search Info"></i>
            <input id="addr" placeholder="Search with CDNSearch">
        </div>

        <button class="toolbar-btn" id="notesBtn" title="Notes"><i class="fa fa-note-sticky"></i></button>
        <button class="toolbar-btn" id="filtersBtn" title="Filters"><i class="fa fa-filter"></i></button>
        <button class="toolbar-btn" id="bookmarksBtn" title="Bookmarks"><i class="fa fa-bookmark"></i></button>
        <button class="toolbar-btn" id="historyBtn" title="History"><i class="fa fa-clock-rotate-left"></i></button>
        <button class="toolbar-btn" id="settingsBtn" title="Settings"><i class="fa fa-gear"></i></button>
    </div>

    <div id="settingsPanel" class="panel">
        <div class="panel-header">
            <h3>Search Settings</h3>
        </div>
        <div class="panel-content">
            <label>
                <div class="checkbox-group">
                    <input type="checkbox" id="deepSearchToggle" checked> <span>Deep Search Mode</span>
                </div>
                <div class="help">Fetch more results from each source (slower but more comprehensive)</div>
            </label>

            <div class="section-divider"></div>
            <label>
                <div class="checkbox-group">
                    <input type="checkbox" id="fuzzToggle" checked>
                    <span>Vary Search Terms</span>
                </div>
                <div class="help">Create multiple query variations for more comprehensive results</div>
            </label>

            <div id="fuzzSettings">
                <label>
                    Search Temperature: <span class="range-value" id="tempValue">50</span>
                    <input id="tempRange" type="range" min="0" max="100" value="50">
                    <div class="help">Controls variation intensity (0 = minimal changes, 100 = stark variations)</div>
                </label>

                <label>
                    Variation Count:
                    <input id="waveCount" type="number" min="1" max="10" value="3">
                    <div class="help">Number of query variations to generate</div>
                </label>
            </div>
            <div class="section-divider"></div>

            <label>
                <div class="checkbox-group">
                    <input type="checkbox" id="cacheToggle" checked>
                    <span>Enable Caching</span>
                </div>
                <div class="help">Cache search results, tabs, and settings for faster loading. Auto-caches every 5 seconds. Turning this off will clear all cached data. Toggling it back on will start fresh.</div>
            </label>

            <label id="cacheSettings">
                <div style="margin-top: 8px;">
                    Cache Expiry (hours):
                    <input id="cacheExpiry" type="number" min="1" max="720" value="24">
                    <div class="help">How long to keep cached results (1-720 hours)</div>
                </div>
                <div style="margin-top: 12px;">
                    <button id="clearCacheBtn" class="export-btn" style="width: 100%; background: #ff3b6b;">
                        <i class="fa fa-trash"></i> Clear Cache Now
                    </button>
                    <div class="help" style="margin-top: 8px;">Note: After clearing cache, auto-caching will resume after 15 seconds</div>
                    <div class="api-status" id="cacheStatus">
                        Cache: <span id="cacheSize">0 KB</span> â€¢ <span id="cacheItems">0 items</span>
                    </div>
                </div>
            </label>
            <div class="section-divider"></div>

            <label>
                Results Per Page (List View):
                <input id="resultsPerPage" type="number" min="5" max="100" value="20">
                <div class="help">Number of results to show per page in list view (5-100)</div>
            </label>

            <label>
                Results Per Page (Grid View):
                <input id="resultsPerPageGrid" type="number" min="6" max="30" step="3" value="21">
                <div class="help">Number of results to show per page in grid view (6-30, multiples of 3)</div>
            </label>

            <div class="section-divider"></div>

            <label>
                <div class="checkbox-group">
                    <input type="checkbox" id="proxyToggle">
                    <span>Use Proxy</span>
                </div>
                <div class="help">Route requests through proxy to bypass CORS restrictions (slower)</div>
            </label>

            <div class="section-divider"></div>

            <label>
                <b>Search Sources</b>
                <div class="help" style="margin-bottom:12px;">Select which APIs to query for results (reload to apply)</div>
                
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #3e3d46;">
                    <div style="font-size: 12px; color: #8f8f9d; margin-bottom: 8px; font-weight: 600;">WEB SEARCH</div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="duckduckgo" checked>
                        <label>DuckDuckGo</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="brave" checked>
                        <label>Brave Search</label>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #3e3d46;">
                    <div style="font-size: 12px; color: #8f8f9d; margin-bottom: 8px; font-weight: 600;">KNOWLEDGE & REFERENCE</div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="wikipedia" checked>
                        <label>Wikipedia</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="wikidata" checked>
                        <label>Wikidata</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="commons" checked>
                        <label>Wikimedia Commons</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="dictionary" checked>
                        <label>Dictionary API</label>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #3e3d46;">
                    <div style="font-size: 12px; color: #8f8f9d; margin-bottom: 8px; font-weight: 600;">PROGRAMMING & TECH</div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="stackoverflow" checked>
                        <label>StackOverflow</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="github" checked>
                        <label>GitHub Repositories</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="npm" checked>
                        <label>npm Packages</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="mozilla" checked>
                        <label>Mozilla MDN</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="devto" checked>
                        <label>Dev.to Articles</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="hackernews" checked>
                        <label>Hacker News</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="reddit" checked>
                        <label>Reddit</label>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #3e3d46;">
                    <div style="font-size: 12px; color: #8f8f9d; margin-bottom: 8px; font-weight: 600;">ACADEMIC & RESEARCH</div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="arxiv" checked>
                        <label>ArXiv Papers</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="pubmed" checked>
                        <label>PubMed Research</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="doaj" checked>
                        <label>DOAJ Journals</label>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #3e3d46;">
                    <div style="font-size: 12px; color: #8f8f9d; margin-bottom: 8px; font-weight: 600;">BOOKS & LITERATURE</div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="openlibrary" checked>
                        <label>Open Library</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="gutenberg" checked>
                        <label>Project Gutenberg</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="quotable" checked>
                        <label>Quotable Quotes</label>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 12px; color: #8f8f9d; margin-bottom: 8px; font-weight: 600;">MEDIA & CULTURE</div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="pixabay" checked>
                        <label>Pixabay Images</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="nasa" checked>
                        <label>NASA Media</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" class="cdnToggle" value="europeana" checked>
                        <label>Europeana Culture</label>
                    </div>
                </div>
            </label>
        </div>
        <div class="panel-footer">
            <button class="clear-all-btn" id="resetSettingsBtn" style="background: #ff3b6b; border-color: #ff3b6b;">
                <i class="fa fa-rotate-left"></i> Reset All Settings
            </button>
        </div>
    </div>

    <div id="searchInfoPanel" class="panel">
        <div class="panel-header">
            <h3>Search Information</h3>
        </div>
        <div class="panel-content">
            <div id="searchInfoContent">
                <div class="search-info-item">
                    <div class="search-info-label">Last Search Query</div>
                    <div class="search-info-value" id="infoLastQuery">No search performed yet</div>
                </div>
                <div class="search-info-item">
                    <div class="search-info-label">Search Time</div>
                    <div class="search-info-value" id="infoSearchTime">-</div>
                </div>
                <div class="search-info-item">
                    <div class="search-info-label">Results Found</div>
                    <div class="search-info-value" id="infoResultsCount">-</div>
                </div>
                <div class="search-info-item">
                    <div class="search-info-label">Active Sources</div>
                    <div class="search-info-value" id="infoActiveSources">-</div>
                </div>
                <div class="search-info-item">
                    <div class="search-info-label">Current Page</div>
                    <div class="search-info-value" id="infoCurrentPage">-</div>
                </div>
                <div class="search-info-item">
                    <div class="search-info-label">Total Pages</div>
                    <div class="search-info-value" id="infoTotalPages">-</div>
                </div>
                <div class="search-info-item">
                    <div class="search-info-value">
                        <div style="font-size: 12px; color: #8f8f9d; margin-top: 4px;">
                            <div>Deep Search: <span id="infoDeepSearch">Off</span></div>
                            <div>Vary Terms: <span id="infoFuzzSearch">On</span></div>
                            <div>Proxy: <span id="infoProxy">Off</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="filtersPanel" class="panel">
        <div class="panel-header">
            <h3>Result Filters</h3>
        </div>
        <div class="panel-content">
            <div class="help" style="margin-bottom:16px;">Filter results by domain or keyword</div>

            <div class="filter-label">
                <b>Filter Presets</b>
                <div class="help" style="margin-bottom:8px;">Quickly apply common filter sets</div>
                <div class="filter-presets">
                    <button class="filter-preset-btn active" data-preset="none">None</button>
                    <button class="filter-preset-btn" data-preset="educational">Educational</button>
                    <button class="filter-preset-btn" data-preset="programming">Programming</button>
                    <button class="filter-preset-btn" data-preset="academic">Academic</button>
                    <button class="filter-preset-btn" data-preset="media">Media</button>
                    <button class="filter-preset-btn" data-preset="culture">Culture</button>
                    <button class="filter-preset-btn" data-preset="science">Science</button>
                </div>
            </div>

            <div class="section-divider"></div>

            <div class="filter-label">
                <div class="checkbox-group">
                    <input type="checkbox" id="domainFilterToggle">
                    <span>Filter by Domain</span>
                </div>
            </div>

            <div id="domainFilterSection" class="disabled-section">
                <label style="font-weight:400;margin:8px 0;">
                    Include only:
                    <div class="help">Enter domains separated by commas</div>
                    <input type="text" id="domainInclude" placeholder="wikipedia.org, stackoverflow.com">
                </label>

                <label style="font-weight:400;margin:16px 0 8px 0;"><br/><br/>
                    Exclude:
                    <div class="help">Enter domains to exclude</div>
                    <input type="text" id="domainExclude" placeholder="example.com, spam.com">
                </label>
            </div>

            <div class="section-divider"></div>

            <div class="filter-label">
                <div class="checkbox-group">
                    <input type="checkbox" id="keywordFilterToggle">
                    <span>Filter by Keywords</span>
                </div>
            </div>

            <div id="keywordFilterSection" class="disabled-section">
                <label style="font-weight:400;margin:8px 0;">
                    Must contain:
                    <div class="help">Results must contain these keywords</div>
                    <input type="text" id="keywordInclude" placeholder="tutorial, guide, how-to">
                </label>

                <label style="font-weight:400;margin:16px 0 8px 0;"><br/><br/>
                    Must not contain:
                    <div class="help">Exclude results with these keywords</div>
                    <input type="text" id="keywordExclude" placeholder="ads, sponsored">
                </label>
            </div>
        </div>
        <div class="panel-footer">
            <button class="clear-all-btn" id="clearFiltersBtn">Clear All Filters</button>
        </div>
    </div>

    <div id="historyPanel" class="panel">
        <div class="panel-header">
            <h3>Search History</h3>
        </div>
        <div class="panel-content">
            <div id="historyList"></div>
        </div>
        <div class="panel-footer">
            <button class="clear-all-btn" id="clearHistoryBtn">Clear All History</button>

            <div class="export-section">
                <div class="import-export-container">
                    <input type="file" id="importHistoryFile" class="file-input" accept=".cdnsearch,.json">
                    <label for="importHistoryFile" class="file-input-label">
                        <i class="fa fa-upload"></i> Import
                    </label>
                    <button class="export-btn" id="exportHistoryBtn"><i class="fa fa-download"></i> Export</button>
                </div>
            </div>
        </div>
    </div>

    <div id="bookmarksPanel" class="panel">
        <div class="panel-header">
            <h3>Bookmarks</h3>
        </div>
        <div class="panel-content">
            <div id="bookmarksList"></div>
        </div>
        <div class="panel-footer">
            <button class="clear-all-btn" id="clearBookmarksBtn">Clear All Bookmarks</button>

            <div class="export-section">
                <div class="import-export-container">
                    <input type="file" id="importBookmarksFile" class="file-input" accept=".cdnsearch,.json">
                    <label for="importBookmarksFile" class="file-input-label">
                        <i class="fa fa-upload"></i> Import
                    </label>
                    <button class="export-btn" id="exportBookmarksBtn"><i class="fa fa-download"></i> Export</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notesPanel" class="panel">
        <div class="panel-header">
            <h3>Quick Notes</h3>
        </div>
        <div class="panel-content">
            <div class="help" style="margin-bottom:12px;">Take notes while researching</div>

            <textarea id="noteInput" placeholder="Write a note..."></textarea>
            <button class="export-btn" id="addNoteBtn"><i class="fa fa-plus"></i> Add Note</button>

            <div id="notesList"></div>
        </div>
        <div class="panel-footer">
            <div class="import-export-container">
                <input type="file" id="importNotesFile" class="file-input" accept=".cdnsearch,.txt,.json">
                <label for="importNotesFile" class="file-input-label">
                    <i class="fa fa-upload"></i> Import Notes
                </label>
                <button class="export-btn" id="exportNotesBtn"><i class="fa fa-download"></i> Export Notes</button>
            </div>
        </div>
    </div>

    <div id="content"></div>

</body>
</html>

<script>
    const content = document.getElementById('content');
    const addr = document.getElementById('addr');
    const lockBtn = document.getElementById('lockBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const historyBtn = document.getElementById('historyBtn');
    const bookmarksBtn = document.getElementById('bookmarksBtn');
    const filtersBtn = document.getElementById('filtersBtn');
    const notesBtn = document.getElementById('notesBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const searchInfoPanel = document.getElementById('searchInfoPanel');
    const historyPanel = document.getElementById('historyPanel');
    const bookmarksPanel = document.getElementById('bookmarksPanel');
    const filtersPanel = document.getElementById('filtersPanel');
    const notesPanel = document.getElementById('notesPanel');
    const historyList = document.getElementById('historyList');
    const bookmarksList = document.getElementById('bookmarksList');
    const notesList = document.getElementById('notesList');
    const fuzzToggle = document.getElementById('fuzzToggle');
    const fuzzSettings = document.getElementById('fuzzSettings');
    const waveCount = document.getElementById('waveCount');
    const proxyToggle = document.getElementById('proxyToggle');
    const deepSearchToggle = document.getElementById('deepSearchToggle');
    const resultsPerPage = document.getElementById('resultsPerPage');
    const resultsPerPageGrid = document.getElementById('resultsPerPageGrid');
    const tempRange = document.getElementById('tempRange');
    const tempValue = document.getElementById('tempValue');
    const cdnToggles = document.querySelectorAll('.cdnToggle');
    const refreshBtn = document.getElementById('refreshBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const clearBookmarksBtn = document.getElementById('clearBookmarksBtn');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const addNoteBtn = document.getElementById('addNoteBtn');
    const noteInput = document.getElementById('noteInput');
    const exportHistoryBtn = document.getElementById('exportHistoryBtn');
    const exportBookmarksBtn = document.getElementById('exportBookmarksBtn');
    const exportNotesBtn = document.getElementById('exportNotesBtn');
    const importHistoryFile = document.getElementById('importHistoryFile');
    const importBookmarksFile = document.getElementById('importBookmarksFile');
    const importNotesFile = document.getElementById('importNotesFile');
    const resetSettingsBtn = document.getElementById('resetSettingsBtn');
    const cacheToggle = document.getElementById('cacheToggle');
    const cacheExpiry = document.getElementById('cacheExpiry');
    const clearCacheBtn = document.getElementById('clearCacheBtn');
    const cacheStatus = document.getElementById('cacheStatus');

    const domainFilterToggle = document.getElementById('domainFilterToggle');
    const keywordFilterToggle = document.getElementById('keywordFilterToggle');
    const domainFilterSection = document.getElementById('domainFilterSection');
    const keywordFilterSection = document.getElementById('keywordFilterSection');
    const domainInclude = document.getElementById('domainInclude');
    const domainExclude = document.getElementById('domainExclude');
    const keywordInclude = document.getElementById('keywordInclude');
    const keywordExclude = document.getElementById('keywordExclude');

    const homeBtn = document.getElementById('homeBtn');
    const backBtn = document.getElementById('backBtn');
    const forwardBtn = document.getElementById('forwardBtn');

    const filterPresetBtns = document.querySelectorAll('.filter-preset-btn');

    const infoLastQuery = document.getElementById('infoLastQuery');
    const infoSearchTime = document.getElementById('infoSearchTime');
    const infoResultsCount = document.getElementById('infoResultsCount');
    const infoActiveSources = document.getElementById('infoActiveSources');
    const infoCurrentPage = document.getElementById('infoCurrentPage');
    const infoTotalPages = document.getElementById('infoTotalPages');
    const infoDeepSearch = document.getElementById('infoDeepSearch');
    const infoFuzzSearch = document.getElementById('infoFuzzSearch');
    const infoProxy = document.getElementById('infoProxy');

    let useProxy = false;
    let fuzzSearch = true;
    let deepSearch = true;
    let activeTabId = 1;
    let activeSearchId = 0;
    const tabSearchIds = {};
    let tabContents = {};
    let searchHistory = [];
    let bookmarks = [];
    let notes = [];

    let currentTabData = {
        lastSearchQuery: '',
        allResults: [],
        imageResults: [],
        filteredResults: [],
        currentPage: 1,
        definitionData: null,
        lastSearchTime: null,
        addressBarValue: '',
        searchStats: {
            totalResults: 0,
            searchTime: 0,
            queryCount: 1,
            sourceCount: 0,
            respondedCount: 0
        },
        gridView: false
    };

    let perPage = 20;
    let perPageGrid = 21;
    
    const SETTINGS_STORAGE = {
        save: function(key, value) {
            localStorage.setItem('cdnsearch_setting_' + key, JSON.stringify(value));
        },
        load: function(key, defaultValue) {
            const item = localStorage.getItem('cdnsearch_setting_' + key);
            return item ? JSON.parse(item) : defaultValue;
        }
    };
    
    let cacheEnabled = SETTINGS_STORAGE.load('cache_enabled', true);
    let cacheExpiryHours = 168;
    let cachePaused = false;
    let cachePauseTimeout = null;
    const CACHE_PREFIX = 'cdnsearch_cache_';
    const CACHE_KEYS = {
        SEARCH: 'search_cache',
        TABS: 'tabs_cache',
        SETTINGS: 'settings_cache',
        HISTORY: 'history_cache',
        BOOKMARKS: 'bookmarks_cache',
        NOTES: 'notes_cache'
    };

    tabContents[1] = {
        type: 'home',
        title: 'New Tab',
        html: '',
        data: {
            lastSearchQuery: '',
            allResults: [],
            imageResults: [],
            filteredResults: [],
            currentPage: 1,
            definitionData: null,
            lastSearchTime: null,
            addressBarValue: '',
            searchStats: {
                totalResults: 0,
                searchTime: 0,
                queryCount: 1,
                sourceCount: 0,
                respondedCount: 0
            },
            gridView: false
        }
    };

    function loadTabData(tabId) {
        const tab = tabContents[tabId];
        if (tab && tab.data) {
            currentTabData = { ...tab.data };
            addr.value = currentTabData.addressBarValue || '';
            perPage = parseInt(resultsPerPage.value) || 20;
            perPageGrid = parseInt(resultsPerPageGrid.value) || 21;
            
            const savedGridView = SETTINGS_STORAGE.load('tab_' + tabId + '_gridview', false);
            currentTabData.gridView = savedGridView;
            
            updateSearchInfo();
        }
    }

    function saveTabData(tabId) {
        if (!tabContents[tabId]) return;
        
        tabContents[tabId].data = { ...currentTabData };
        tabContents[tabId].data.addressBarValue = addr.value;
        
        tabContents[tabId].html = content.innerHTML;
        
        const tabElement = document.querySelector(`.tab[data-tab="${tabId}"]`);
        if (tabElement && !tabElement.classList.contains('add-tab')) {
            const titleSpan = tabElement.querySelector('.tab-content span');
            if (titleSpan) {
                tabContents[tabId].title = titleSpan.textContent;
            }
        }
    }

    let tabsInitialized = false;
    
    function initializeTabs() {
        if (tabsInitialized) return;
        tabsInitialized = true;
        
        document.querySelectorAll('.tab:not(.add-tab)').forEach(tab => {
            tab.addEventListener('click', (e) => {
                if (e.target.closest('.tab-close')) {
                    const tabId = tab.dataset.tab;
                    closeTab(tabId, e);
                    return;
                }
                const tabId = tab.dataset.tab;
                switchTab(tabId);
            });
        });

        const addTabBtn = document.querySelector('.tab.add-tab');
        if (!addTabBtn.dataset.initialized) {
            addTabBtn.dataset.initialized = 'true';
            addTabBtn.addEventListener('click', () => {
                activeTabId++;
                addTab(activeTabId);
            });
        }
    }

    function switchTab(tabId) {
        if (!tabId || parseInt(tabId) === activeTabId) return;
        
        const oldTabId = activeTabId;
        if (tabSearchIds[oldTabId]) {
            tabSearchIds[oldTabId] = -1;
        }
        
        saveTabData(activeTabId);
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const tab = document.querySelector(`.tab[data-tab="${tabId}"]`);
        if (tab) {
            tab.classList.add('active');
            activeTabId = parseInt(tabId);
            
            loadTabData(activeTabId);
            
            requestAnimationFrame(() => {
                restoreTab(activeTabId);
                setTimeout(() => saveTabCache(), 100);
            });
        }
    }

    function closeTab(tabId, e) {
        if (e) e.stopPropagation();

        const tab = document.querySelector(`.tab[data-tab="${tabId}"]`);
        if (!tab) return;

        const allTabs = document.querySelectorAll('.tab:not(.add-tab)');
        if (allTabs.length <= 1) return;

        const wasActive = tab.classList.contains('active');
        tab.remove();

        delete tabContents[tabId];

        if (wasActive) {
            const remainingTabs = document.querySelectorAll('.tab:not(.add-tab)');
            if (remainingTabs.length > 0) {
                const lastTab = remainingTabs[remainingTabs.length - 1];
                const lastTabId = lastTab.dataset.tab;
                switchTab(lastTabId);
            }
        } else {
            setTimeout(() => saveTabCache(), 100);
        }
    }

    function addTab(id) {
        const tabbar = document.getElementById('tabbar');
        const addTabBtn = document.querySelector('.tab.add-tab');
        
        const tab = document.createElement('div');
        tab.className = 'tab active';
        tab.dataset.tab = id;
        tab.innerHTML = `
            <div class="tab-content">
                <i class="fa-solid fa-globe"></i>
                <span>New Tab</span>
            </div>
            <button class="tab-close" title="Close tab"><i class="fa fa-times"></i></button>
        `;
        
        tabbar.insertBefore(tab, addTabBtn);
        
        document.querySelectorAll('.tab:not(.add-tab)').forEach(t => {
            if (t.dataset.tab != id) {
                t.classList.remove('active');
                const oldId = parseInt(t.dataset.tab);
                if (tabSearchIds[oldId]) {
                    tabSearchIds[oldId] = -1;
                }
            }
        });
        
        activeTabId = id;
        
        tabContents[id] = {
            type: 'home',
            title: 'New Tab',
            html: '',
            data: {
                lastSearchQuery: '',
                allResults: [],
                imageResults: [],
                filteredResults: [],
                currentPage: 1,
                definitionData: null,
                lastSearchTime: null,
                addressBarValue: '',
                searchStats: {
                    totalResults: 0,
                    searchTime: 0,
                    queryCount: 1,
                    sourceCount: 0,
                    respondedCount: 0
                },
                gridView: false
            }
        };
        
        loadTabData(id);
        
        showHome();
        addr.value = '';
        
        tab.addEventListener('click', (e) => {
            if (e.target.closest('.tab-close')) {
                closeTab(id, e);
                return;
            }
            switchTab(id);
        });
        
        tab.querySelector('.tab-close').addEventListener('click', (e) => {
            e.stopPropagation();
            closeTab(id, e);
        });
        saveTabCache();
    }

    function updateTabTitle(tabId, title) {
        const tab = document.querySelector(`.tab[data-tab="${tabId}"]`);
        if (tab && !tab.classList.contains('add-tab')) {
            const displayTitle = title.length > 15 ? title.substring(0, 15) + '...' : title;

            const isLowercase = title === title.toLowerCase() && /[a-z]/.test(title);

            if (isLowercase) {
                tab.classList.add('lowercase');
            } else {
                tab.classList.remove('lowercase');
            }

            const titleSpan = tab.querySelector('.tab-content span');
            if (titleSpan) {
                titleSpan.textContent = displayTitle;
            }

            if (tabContents[tabId]) {
                tabContents[tabId].title = title;
            }
        }
    }

    function restoreTab(tabId) {
        const saved = tabContents[tabId];
        if (!saved) {
            showHome();
            return;
        }

        if (saved.type === 'home' || !saved.html) {
            showHome();
        } else {
            requestAnimationFrame(() => {
                content.innerHTML = saved.html || '';
                
                addr.value = saved.data?.addressBarValue || '';
                
                updateTabTitle(activeTabId, saved.title || 'New Tab');
                
                attachBookmarkListeners();
                attachCopyButtonListeners();
                attachPaginationListeners();
                
                const homeSearch = document.getElementById("homeSearch");
                if (homeSearch) {
                    homeSearch.addEventListener("keydown", e => {
                        if (e.key === "Enter") {
                            const query = e.target.value.trim();
                            if (query) {
                                runSearch(query);
                            }
                        }
                    });
                }
            });
        }
    }

    let navHistory = {
        past: [],
        future: [],
        current: {
            type: 'home',
            query: ''
        }
    };

    function addToHistory(type, query) {
        if (type === navHistory.current.type && query === navHistory.current.query) {
            return;
        }
        
        navHistory.past.push({
            ...navHistory.current
        });
        navHistory.current = {
            type,
            query
        };
        navHistory.future = [];
        updateNavButtons();
        
        if (type === 'search') {
            const historyItem = {
                query: query,
                time: Date.now()
            };
            
            const existingIndex = searchHistory.findIndex(h => h.query === query);
            if (existingIndex !== -1) {
                searchHistory.splice(existingIndex, 1);
            }
            
            searchHistory.unshift(historyItem);
            
            if (searchHistory.length > 50) {
                searchHistory = searchHistory.slice(0, 50);
            }
        }
    }

    function updateNavButtons() {
        const isHomePage = navHistory.current.type === 'home';
        
        backBtn.disabled = navHistory.past.length === 0;
        forwardBtn.disabled = navHistory.future.length === 0;
        refreshBtn.disabled = isHomePage && navHistory.current.query === '';

        [backBtn, forwardBtn, refreshBtn].forEach(btn => {
            if (btn.disabled) {
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            } else {
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
    }

    function goBack() {
        if (navHistory.past.length > 0) {
            navHistory.future.unshift({
                ...navHistory.current
            });
            navHistory.current = navHistory.past.pop();
            applyNavigationState();
        }
    }

    function goForward() {
        if (navHistory.future.length > 0) {
            navHistory.past.push({
                ...navHistory.current
            });
            navHistory.current = navHistory.future.shift();
            applyNavigationState();
        }
    }

    function applyNavigationState() {
        if (navHistory.current.type === 'home') {
            showHome();
            addr.value = '';
            updateTabTitle(activeTabId, 'New Tab');
        } else if (navHistory.current.type === 'search') {
            addr.value = navHistory.current.query;
            runSearch(navHistory.current.query, true);
        }
        updateNavButtons();
    }

    function setupQuickShortcuts() {
        // Quick shortcuts now use native link behavior with target="_blank"
        // No need to override click events
    }

    function showHome() {
        if (!tabContents[activeTabId]) {
            tabContents[activeTabId] = {
                type: 'home',
                title: 'New Tab',
                html: '',
                data: { ...currentTabData }
            };
        }

        content.innerHTML = `
            <div class="home">
                <div class="logo-header">
                    <div class="logo-container">
                        <span class="logo-badge">CDN</span>
                        <span class="logo">Search</span>
                    </div>
                    <div class="byline">by dinguschan</div>
                </div>
                <div class="searchbox">
                    <button id="homeSearchIcon" class="search-icon-btn" title="Search">
                        <i class="fa fa-magnifying-glass"></i>
                    </button>
                    <input id="homeSearch" placeholder="Search the web">
                </div>
                <div class="quick-shortcuts">
                    <a href="https://cdnsearch.vercel.app/" target="_blank" class="shortcut shortcut-website">
                        <div class="shortcut-icon">
                            <i class="fa-solid fa-globe"></i>
                        </div>
                        <div class="shortcut-label">Website <i class="fa-solid fa-up-right-from-square" style="font-size:10px;margin-left:4px;"></i></div>
                    </a>
                    <a href="https://github.com/dinguschan-owo/CDNSearch" target="_blank" class="shortcut shortcut-github">
                        <div class="shortcut-icon">
                            <i class="fa-brands fa-github"></i>
                        </div>
                        <div class="shortcut-label">GitHub <i class="fa-solid fa-up-right-from-square" style="font-size:10px;margin-left:4px;"></i></div>
                    </a>
                    <a href="https://github.com/dinguschan-owo/CDNSearch/issues" target="_blank" class="shortcut shortcut-issues">
                        <div class="shortcut-icon">
                            <i class="fa-solid fa-bug"></i>
                        </div>
                        <div class="shortcut-label">Issues <i class="fa-solid fa-up-right-from-square" style="font-size:10px;margin-left:4px;"></i></div>
                    </a>
                </div>
            </div>
        `;

        const homeSearch = document.getElementById("homeSearch");
        const homeSearchIcon = document.getElementById("homeSearchIcon");

        if (homeSearch) {
            homeSearch.addEventListener("keydown", e => {
                if (e.key === "Enter") {
                    const query = e.target.value.trim();
                    if (query) {
                        addToHistory('search', query);
                        runSearch(query);
                    }
                }
            });

            if (homeSearchIcon) {
                homeSearchIcon.addEventListener("click", () => {
                    const query = homeSearch.value.trim();
                    if (query) {
                        addToHistory('search', query);
                        runSearch(query);
                    }
                });
            }
        }

        setupQuickShortcuts();
        updateNavButtons();
        
        tabContents[activeTabId].type = 'home';
        saveTabData(activeTabId);
    }

    showHome();
    updateNavButtons();
    initializeTabs();

    homeBtn.addEventListener("click", () => {
        addToHistory('home', '');
        showHome();
        addr.value = '';
        updateTabTitle(activeTabId, 'New Tab');
    });

    backBtn.addEventListener("click", goBack);

    forwardBtn.addEventListener("click", goForward);

    addr.addEventListener("keydown", e => {
        if (e.key === "Enter") {
            const query = addr.value.trim();
            if (query) {
                addToHistory('search', query);
                runSearch(query);
            }
        }
    });

    refreshBtn.addEventListener("click", () => {
        if (navHistory.current.type === 'search' && navHistory.current.query) {
            runSearch(navHistory.current.query);
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        } else if (navHistory.current.type === 'home') {
            showHome();
        }
    });

    function closeAllPanels() {
        settingsPanel.style.display = "none";
        searchInfoPanel.style.display = "none";
        historyPanel.style.display = "none";
        bookmarksPanel.style.display = "none";
        filtersPanel.style.display = "none";
        notesPanel.style.display = "none";
    }

    closeAllPanels();

    lockBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const wasOpen = searchInfoPanel.style.display === "flex";
        closeAllPanels();
        searchInfoPanel.style.display = wasOpen ? "none" : "flex";
    });

    settingsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const wasOpen = settingsPanel.style.display === "flex";
        closeAllPanels();
        settingsPanel.style.display = wasOpen ? "none" : "flex";
    });

    historyBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const wasOpen = historyPanel.style.display === "flex";
        closeAllPanels();
        renderHistory();
        historyPanel.style.display = wasOpen ? "none" : "flex";
    });

    bookmarksBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const wasOpen = bookmarksPanel.style.display === "flex";
        closeAllPanels();
        renderBookmarks();
        bookmarksPanel.style.display = wasOpen ? "none" : "flex";
    });

    filtersBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const wasOpen = filtersPanel.style.display === "flex";
        closeAllPanels();
        filtersPanel.style.display = wasOpen ? "none" : "flex";
    });

    notesBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const wasOpen = notesPanel.style.display === "flex";
        closeAllPanels();
        renderNotes();
        notesPanel.style.display = wasOpen ? "none" : "flex";
    });

    addNoteBtn.addEventListener("click", () => {
        const text = noteInput.value.trim();
        if (text) {
            const noteQuery = currentTabData.lastSearchQuery ? currentTabData.lastSearchQuery : 'N/A';
            notes.unshift({
                content: text,
                time: Date.now(),
                query: noteQuery
            });
            noteInput.value = '';
            renderNotes();
        }
    });

    filterPresetBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            filterPresetBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const preset = btn.dataset.preset;
            applyFilterPreset(preset);
        });
    });

    function isCacheExpired(timestamp) {
        if (!timestamp) return true;
        const now = Date.now();
        const expiryTime = cacheExpiryHours * 60 * 60 * 1000;
        return (now - timestamp) > expiryTime;
    }

    function getCacheKey(key, query = '') {
        const tabKey = `tab${activeTabId}`;
        return query ? `${CACHE_PREFIX}${key}_${tabKey}_${query}` : `${CACHE_PREFIX}${key}_${tabKey}`;
    }

    function saveToCache(key, data, query = '') {
        if (!cacheEnabled || cachePaused) return;
        
        const cacheKey = getCacheKey(key, query);
        const cacheItem = {
            data: data,
            timestamp: Date.now(),
            query: query,
            tabId: activeTabId
        };
        
        try {
            localStorage.setItem(cacheKey, JSON.stringify(cacheItem));
            updateCacheStatus();
        } catch (error) {
            console.error('Failed to save to cache:', error);
            clearExpiredCache();
            try {
                localStorage.setItem(cacheKey, JSON.stringify(cacheItem));
            } catch (e) {
                console.error('Still cannot save to cache:', e);
            }
        }
    }

    function loadFromCache(key, query = '') {
        if (!cacheEnabled) return null;
        
        const cacheKey = getCacheKey(key, query);
        const cached = localStorage.getItem(cacheKey);
        
        if (!cached) return null;
        
        try {
            const parsed = JSON.parse(cached);
            
            if (isCacheExpired(parsed.timestamp)) {
                localStorage.removeItem(cacheKey);
                return null;
            }
            
            return parsed.data;
        } catch (error) {
            console.error('Failed to load from cache:', error);
            localStorage.removeItem(cacheKey);
            return null;
        }
    }

function clearCache() {
    cachePaused = true;
    
    if (cachePauseTimeout) {
        clearTimeout(cachePauseTimeout);
    }
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(CACHE_PREFIX) && !key.includes(CACHE_KEYS.SETTINGS)) {
            localStorage.removeItem(key);
            i--;
        }
    }
    
    updateCacheStatus();
    
    cachePauseTimeout = setTimeout(() => {
        cachePaused = false;
        updateCacheStatus();
    }, 15000);
}

    function clearExpiredCache() {
        const now = Date.now();
        const expiryTime = cacheExpiryHours * 60 * 60 * 1000;
        let cleared = 0;
        
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(CACHE_PREFIX)) {
                try {
                    const item = JSON.parse(localStorage.getItem(key));
                    if (now - item.timestamp > expiryTime) {
                        localStorage.removeItem(key);
                        cleared++;
                        i--;
                    }
                } catch (error) {
                    localStorage.removeItem(key);
                    cleared++;
                    i--;
                }
            }
        }
        
        if (cleared > 0) {
            console.log(`Cleared ${cleared} expired cache items`);
        }
        updateCacheStatus();
        return cleared;
    }

    function saveSearchResults(query, results, images, definitionData) {
        if (!cacheEnabled || cachePaused) return;
        
        const cacheData = {
            query: query,
            results: results,
            images: images || [],
            definitionData: definitionData || null,
            timestamp: Date.now()
        };
        
        saveToCache(CACHE_KEYS.SEARCH, cacheData, query);
    }

    function loadSearchResults(query) {
        if (!cacheEnabled) return null;
        
        const cached = loadFromCache(CACHE_KEYS.SEARCH, query);
        if (!cached) return null;
        
        if (cached.query === query) {
            console.log('Loaded search results from cache');
            return cached;
        }
        
        return null;
    }

    let saveTabCacheTimeout = null;
    
    function saveTabCache() {
        if (!cacheEnabled || cachePaused) return;
        
        if (saveTabCacheTimeout) {
            clearTimeout(saveTabCacheTimeout);
        }
        
        saveTabCacheTimeout = setTimeout(() => {
            const tabCacheData = {
                tabs: tabContents,
                activeTabId: activeTabId,
                addressBarValue: addr.value,
                timestamp: Date.now()
            };
            
            saveToCache(CACHE_KEYS.TABS, tabCacheData);
            saveTabCacheTimeout = null;
        }, 500);
    }

    function loadTabCache() {
        if (!cacheEnabled) return false;
        
        const cached = loadFromCache(CACHE_KEYS.TABS);
        if (!cached) return false;
        
        if (cached.tabs && Object.keys(cached.tabs).length > 0) {
            tabContents = cached.tabs;
            activeTabId = cached.activeTabId || 1;
            
            restoreCachedTabs();
            
            if (cached.addressBarValue) {
                addr.value = cached.addressBarValue;
            }
            
            console.log('Loaded tabs from cache');
            return true;
        }
        
        return false;
    }

    function restoreCachedTabs() {
        const tabbar = document.getElementById('tabbar');
        const addTabBtn = document.querySelector('.tab.add-tab');
        
        document.querySelectorAll('.tab:not(.add-tab)').forEach(tab => tab.remove());
        
        if (!tabContents) tabContents = {};
        
        Object.keys(tabContents).forEach(tabId => {
            const tabData = tabContents[tabId];
            
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.tab = tabId;
            
            if (parseInt(tabId) === activeTabId) {
                tab.classList.add('active');
            }
            
            const displayTitle = tabData.title && tabData.title.length > 15 ? 
                tabData.title.substring(0, 15) + '...' : 
                (tabData.title || 'New Tab');
            
            const isLowercase = tabData.title === tabData.title.toLowerCase() && /[a-z]/.test(tabData.title);
            
            if (isLowercase) {
                tab.classList.add('lowercase');
            }
            
            tab.innerHTML = `
                <div class="tab-content">
                    <i class="fa-solid fa-globe"></i>
                    <span>${displayTitle}</span>
                </div>
                <button class="tab-close" title="Close tab"><i class="fa fa-times"></i></button>
            `;
            
            tabbar.insertBefore(tab, addTabBtn);
            
            tab.addEventListener('click', (e) => {
                if (e.target.closest('.tab-close')) {
                    closeTab(tabId, e);
                    return;
                }
                switchTab(tabId);
            });
            
            tab.querySelector('.tab-close').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(tabId, e);
            });
        });
        
        if (!tabContents[activeTabId]) {
            activeTabId = Math.max(...Object.keys(tabContents).map(Number)) || 1;
        }
        
        loadTabData(activeTabId);
        restoreTab(activeTabId);
    }

    function saveSettingsCache() {
        if (!cacheEnabled || cachePaused) return;
        
        const settingsData = {
            useProxy: useProxy,
            fuzzSearch: fuzzSearch,
            deepSearch: deepSearch,
            perPage: perPage,
            perPageGrid: perPageGrid,
            tempValue: parseInt(tempRange.value) || 50,
            waveCount: parseInt(waveCount.value) || 3,
            selectedSources: getSelectedSources(),
            timestamp: Date.now()
        };
        
        saveToCache(CACHE_KEYS.SETTINGS, settingsData);
    }

    function loadSettingsCache() {
        if (!cacheEnabled) return false;
        
        const cached = loadFromCache(CACHE_KEYS.SETTINGS);
        if (!cached) return false;
        
        useProxy = cached.useProxy || false;
        fuzzSearch = cached.fuzzSearch !== undefined ? cached.fuzzSearch : true;
        deepSearch = cached.deepSearch !== undefined ? cached.deepSearch : true;
        perPage = cached.perPage || 20;
        perPageGrid = cached.perPageGrid || 21;
        
        proxyToggle.checked = useProxy;
        fuzzToggle.checked = fuzzSearch;
        deepSearchToggle.checked = deepSearch;
        resultsPerPage.value = perPage;
        resultsPerPageGrid.value = perPageGrid;
        
        if (cached.tempValue) {
            tempRange.value = cached.tempValue;
            tempValue.textContent = cached.tempValue;
        }
        
        if (cached.waveCount) {
            waveCount.value = cached.waveCount;
        }
        
        if (cached.selectedSources) {
            setSelectedSources(cached.selectedSources);
        }
        
        if (fuzzSearch) {
            fuzzSettings.classList.remove('disabled-section');
        } else {
            fuzzSettings.classList.add('disabled-section');
        }
        waveCount.disabled = !fuzzSearch;
        tempRange.disabled = !fuzzSearch;
        
        console.log('Loaded settings from cache');
        return true;
    }

    function getSelectedSources() {
        return Array.from(cdnToggles)
            .filter(toggle => toggle.checked)
            .map(toggle => toggle.value);
    }

    function setSelectedSources(sources) {
        cdnToggles.forEach(toggle => {
            toggle.checked = sources.includes(toggle.value);
        });
    }

    function saveUserDataCache() {
        if (!cacheEnabled || cachePaused) return;
        
        saveToCache(CACHE_KEYS.HISTORY, searchHistory);
        saveToCache(CACHE_KEYS.BOOKMARKS, bookmarks);
        saveToCache(CACHE_KEYS.NOTES, notes);
    }

    function loadUserDataCache() {
        if (!cacheEnabled) return false;
        
        const cachedHistory = loadFromCache(CACHE_KEYS.HISTORY);
        const cachedBookmarks = loadFromCache(CACHE_KEYS.BOOKMARKS);
        const cachedNotes = loadFromCache(CACHE_KEYS.NOTES);
        
        let loaded = false;
        
        if (cachedHistory) {
            searchHistory = cachedHistory;
            loaded = true;
        }
        
        if (cachedBookmarks) {
            bookmarks = cachedBookmarks;
            loaded = true;
        }
        
        if (cachedNotes) {
            notes = cachedNotes;
            loaded = true;
        }
        
        if (loaded) {
            console.log('Loaded user data from cache');
            renderHistory();
            renderBookmarks();
            renderNotes();
        }
        
        return loaded;
    }

function updateCacheStatus() {
    if (!document.getElementById('cacheStatus')) return;
    
    let totalSize = 0;
    let itemCount = 0;
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith(CACHE_PREFIX) && !key.includes(CACHE_KEYS.SETTINGS)) {
            itemCount++;
            try {
                const value = localStorage.getItem(key);
                totalSize += key.length + value.length;
            } catch (e) {
            }
        }
    }
    
    const sizeKB = (totalSize / 1024).toFixed(1);
    
    const cacheStatusEl = document.getElementById('cacheStatus');
    let statusHTML = `Cache: <span id="cacheSize">${sizeKB} KB</span> â€¢ <span id="cacheItems">${itemCount} items</span>`;
    
    if (cachePaused) {
        statusHTML += ' â€¢ <span style="color: #ff3b6b">(Paused for 15s)</span>';
    }
    
    cacheStatusEl.innerHTML = statusHTML;
}

    function initializeCache() {
        const savedExpiry = localStorage.getItem('cdnsearch_cache_expiry');
        
        if (savedExpiry !== null) {
            cacheExpiryHours = parseInt(savedExpiry) || 24;
        }
        
        cacheToggle.checked = cacheEnabled;
        cacheExpiry.value = cacheExpiryHours;
        
        cacheToggle.addEventListener('change', (e) => {
            cacheEnabled = e.target.checked;
            SETTINGS_STORAGE.save('cache_enabled', cacheEnabled);
            
            if (!cacheEnabled) {
                clearCache();
            } else {
                updateCacheStatus();
            }
            
            const cacheSettings = document.getElementById('cacheSettings');
            if (cacheSettings) {
                if (cacheEnabled) {
                    cacheSettings.classList.remove('disabled-section');
                } else {
                    cacheSettings.classList.add('disabled-section');
                }
            }
        });
        
        cacheExpiry.addEventListener('change', (e) => {
            cacheExpiryHours = parseInt(e.target.value) || 24;
            localStorage.setItem('cdnsearch_cache_expiry', cacheExpiryHours);
            saveSettingsCache();
        });
        
        clearCacheBtn.addEventListener('click', () => {
            if (confirm('Clear all cached search results and tabs? Auto-caching will resume after 15 seconds.')) {
                clearCache();
                alert('Cache cleared successfully! Auto-caching will resume in 15 seconds.');
            }
        });
        
        const cacheSettings = document.getElementById('cacheSettings');
        if (cacheSettings) {
            if (cacheEnabled) {
                cacheSettings.classList.remove('disabled-section');
            } else {
                cacheSettings.classList.add('disabled-section');
            }
        }
        
        if (cacheEnabled) {
            clearExpiredCache();
        }
        
        if (cacheEnabled) {
            loadSettingsCache();
            loadUserDataCache();
            const tabsLoaded = loadTabCache();
            
            if (!tabsLoaded) {
                showHome();
                initializeTabs();
            }
        } else {
            showHome();
            initializeTabs();
        }
        
        updateCacheStatus();
    }

    function setupCacheSaving() {
        [proxyToggle, fuzzToggle, deepSearchToggle, resultsPerPage, resultsPerPageGrid, tempRange, waveCount].forEach(element => {
            if (element) {
                element.addEventListener('change', () => {
                    saveSettingsCache();
                });
            }
        });
        
        cdnToggles.forEach(toggle => {
            toggle.addEventListener('change', () => {
                saveSettingsCache();
            });
        });
        
        const saveUserData = () => {
            saveUserDataCache();
        };
        
        const originalToggleBookmark = toggleBookmark;
        toggleBookmark = function(...args) {
            const result = originalToggleBookmark.apply(this, args);
            saveUserDataCache();
            return result;
        };
        
        addNoteBtn.addEventListener('click', () => {
            setTimeout(saveUserDataCache, 100);
        });
        
        setInterval(() => {
            if (cacheEnabled && !cachePaused) {
                saveTabCache();
                saveSettingsCache();
                saveUserDataCache();
            }
        }, 5000);
        
        window.addEventListener('beforeunload', () => {
            if (cacheEnabled && !cachePaused) {
                saveTabCache();
                saveSettingsCache();
                saveUserDataCache();
            }
        });
    }

    window.addEventListener('load', () => {
        initializeCache();
        setupCacheSaving();
        updateNavButtons();
        
        document.body.addEventListener('click', (e) => {
            const btn = e.target.closest('#toggleGridView');
            if (btn) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!currentTabData.filteredResults || currentTabData.filteredResults.length === 0) {
                    return;
                }
                
                currentTabData.gridView = !currentTabData.gridView;
                SETTINGS_STORAGE.save('tab_' + activeTabId + '_gridview', currentTabData.gridView);
                displayResults(currentTabData.filteredResults, currentTabData.imageResults);
            }
        });
    });

    function applyFilterPreset(preset) {
        const toggles = Array.from(cdnToggles);
        
        if (preset === 'none') {
            toggles.forEach(toggle => {
                toggle.checked = true;
            });
        } 
        else if (preset === 'educational') {
            const educationalSources = [
                'wikipedia', 'openlibrary', 'dictionary', 'quotable', 
                'duckduckgo', 'brave', 'wikidata', 'gutenberg', 'commons'
            ];
            
            toggles.forEach(toggle => {
                toggle.checked = educationalSources.includes(toggle.value);
            });
        } 
        else if (preset === 'programming') {
            const programmingSources = [
                'stackoverflow', 'github', 'npm', 'mozilla', 
                'devto', 'hackernews', 'duckduckgo', 'brave'
            ];
            
            toggles.forEach(toggle => {
                toggle.checked = programmingSources.includes(toggle.value);
            });
        }
        else if (preset === 'academic') {
            const academicSources = [
                'arxiv', 'pubmed', 'doaj', 'wikipedia', 
                'wikidata', 'gutenberg', 'openlibrary'
            ];
            
            toggles.forEach(toggle => {
                toggle.checked = academicSources.includes(toggle.value);
            });
        }
        else if (preset === 'media') {
            const mediaSources = [
                'pixabay', 'commons', 'nasa', 'wikipedia',
                'duckduckgo', 'brave'
            ];
            
            toggles.forEach(toggle => {
                toggle.checked = mediaSources.includes(toggle.value);
            });
        }
        else if (preset === 'culture') {
            const cultureSources = [
                'europeana', 'commons', 'openlibrary', 'gutenberg',
                'wikipedia', 'wikidata', 'quotable'
            ];
            
            toggles.forEach(toggle => {
                toggle.checked = cultureSources.includes(toggle.value);
            });
        }
        else if (preset === 'science') {
            const scienceSources = [
                'nasa', 'arxiv', 'pubmed', 'wikipedia',
                'stackoverflow', 'github', 'mozilla'
            ];
            
            toggles.forEach(toggle => {
                toggle.checked = scienceSources.includes(toggle.value);
            });
        }
        
        if (currentTabData.lastSearchQuery) {
            runSearch(currentTabData.lastSearchQuery, true);
        }
    }

    function exportWithCustomExtension(data, filename, type) {
        if (!filename.endsWith('.cdnsearch')) {
            filename = filename.replace(/\.[^/.]+$/, "") + '.cdnsearch';
        }

        const blob = new Blob([data], {
            type
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    exportHistoryBtn.addEventListener("click", () => {
        const data = JSON.stringify({
            type: 'cdnsearch_history',
            version: '1.0',
            timestamp: new Date().toISOString(),
            data: searchHistory
        }, null, 2);
        exportWithCustomExtension(data, 'cdnsearch-history.cdnsearch', 'application/json');
    });

    exportBookmarksBtn.addEventListener("click", () => {
        const data = JSON.stringify({
            type: 'cdnsearch_bookmarks',
            version: '1.0',
            timestamp: new Date().toISOString(),
            data: bookmarks
        }, null, 2);
        exportWithCustomExtension(data, 'cdnsearch-bookmarks.cdnsearch', 'application/json');
    });

    exportNotesBtn.addEventListener("click", () => {
        const data = JSON.stringify({
            type: 'cdnsearch_notes',
            version: '1.0',
            timestamp: new Date().toISOString(),
            data: notes
        }, null, 2);
        exportWithCustomExtension(data, 'cdnsearch-notes.cdnsearch', 'application/json');
    });

    importHistoryFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const text = await file.text();
            let parsed;

            try {
                parsed = JSON.parse(text);
            } catch (jsonError) {
                alert('Invalid file format. Please use a .cdnsearch or .json file exported from CDNSearch.');
                return;
            }

            let importData;
            if (parsed.type && parsed.type === 'cdnsearch_history') {
                importData = parsed.data;
            } else if (Array.isArray(parsed)) {
                importData = parsed;
            } else {
                alert('Invalid file format. Please use a file exported from CDNSearch.');
                return;
            }

            if (confirm(`Import ${importData.length} history items? This will add to your existing history.`)) {
                const existingQueries = new Set(searchHistory.map(h => `${h.query}_${h.time}`));
                const newItems = importData.filter(item => {
                    const key = `${item.query}_${item.time}`;
                    return !existingQueries.has(key);
                });

                searchHistory = [...newItems, ...searchHistory];
                if (searchHistory.length > 200) {
                    searchHistory = searchHistory.slice(0, 200);
                }

                renderHistory();
                alert(`Successfully imported ${newItems.length} history items.`);
            }
        } catch (error) {
            console.error('Import error:', error);
            alert('Error importing file. Please check the file format.');
        }

        e.target.value = '';
    });

    importBookmarksFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const text = await file.text();
            let parsed;

            try {
                parsed = JSON.parse(text);
            } catch (jsonError) {
                alert('Invalid file format. Please use a .cdnsearch or .json file exported from CDNSearch.');
                return;
            }

            let importData;
            if (parsed.type && parsed.type === 'cdnsearch_bookmarks') {
                importData = parsed.data;
            } else if (Array.isArray(parsed)) {
                importData = parsed;
            } else {
                alert('Invalid file format. Please use a file exported from CDNSearch.');
                return;
            }

            if (confirm(`Import ${importData.length} bookmarks? This will add to your existing bookmarks.`)) {
                const existingUrls = new Set(bookmarks.map(b => b.url));
                const newItems = importData.filter(item => !existingUrls.has(item.url));

                bookmarks = [...bookmarks, ...newItems];
                renderBookmarks();
                attachBookmarkListeners();
                alert(`Successfully imported ${newItems.length} bookmarks.`);
            }
        } catch (error) {
            console.error('Import error:', error);
            alert('Error importing file. Please check the file format.');
        }

        e.target.value = '';
    });

    importNotesFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const text = await file.text();

            try {
                const parsed = JSON.parse(text);

                let importData;
                if (parsed.type && parsed.type === 'cdnsearch_notes') {
                    importData = parsed.data;
                } else if (Array.isArray(parsed)) {
                    importData = parsed;
                } else {
                    throw new Error('Invalid JSON format');
                }

                if (confirm(`Import ${importData.length} notes? This will add to your existing notes.`)) {
                    const existingNotes = new Set(notes.map(n => `${n.content}_${n.time}`));
                    const newItems = importData.filter(item => {
                        const key = `${item.content}_${item.time}`;
                        return !existingNotes.has(key);
                    });

                    notes = [...newItems, ...notes];
                    renderNotes();
                    alert(`Successfully imported ${newItems.length} notes.`);
                }
            } catch (jsonError) {
                if (confirm('Import notes from text file? This will add to your existing notes.')) {
                    const newNote = {
                        content: text.trim(),
                        time: Date.now(),
                        query: 'Imported Notes'
                    };

                    notes.unshift(newNote);
                    renderNotes();
                    alert('Successfully imported notes from text file.');
                }
            }
        } catch (error) {
            console.error('Import error:', error);
            alert('Error importing file. Please check the file format.');
        }

        e.target.value = '';
    });

    domainFilterToggle.addEventListener("change", (e) => {
        if (e.target.checked) {
            domainFilterSection.classList.remove('disabled-section');
        } else {
            domainFilterSection.classList.add('disabled-section');
        }
        applyFilters();
    });

    keywordFilterToggle.addEventListener("change", (e) => {
        if (e.target.checked) {
            keywordFilterSection.classList.remove('disabled-section');
        } else {
            keywordFilterSection.classList.add('disabled-section');
        }
        applyFilters();
    });

    domainInclude.addEventListener("input", () => applyFilters());
    domainExclude.addEventListener("input", () => applyFilters());
    keywordInclude.addEventListener("input", () => applyFilters());
    keywordExclude.addEventListener("input", () => applyFilters());

    clearFiltersBtn.addEventListener("click", () => {
        domainFilterToggle.checked = false;
        keywordFilterToggle.checked = false;
        domainInclude.value = '';
        domainExclude.value = '';
        keywordInclude.value = '';
        keywordExclude.value = '';
        domainFilterSection.classList.add('disabled-section');
        keywordFilterSection.classList.add('disabled-section');
        applyFilters();
    });

    resetSettingsBtn.addEventListener("click", () => {
        if (confirm('Reset all settings to default? This will reload the page.')) {
            useProxy = false;
            fuzzSearch = true;
            deepSearch = true;
            perPage = 20;
            perPageGrid = 21;
            
            proxyToggle.checked = false;
            fuzzToggle.checked = true;
            deepSearchToggle.checked = true;
            resultsPerPage.value = 20;
            resultsPerPageGrid.value = 21;
            tempRange.value = 50;
            tempValue.textContent = 50;
            waveCount.value = 3;
            
            cdnToggles.forEach(toggle => {
                toggle.checked = true;
            });
            
            fuzzSettings.classList.remove('disabled-section');
            waveCount.disabled = false;
            tempRange.disabled = false;
            
            const settingsCacheKey = getCacheKey(CACHE_KEYS.SETTINGS);
            localStorage.removeItem(settingsCacheKey);
            
            saveSettingsCache();
            
            alert('Settings reset to defaults! The page will reload.');
            location.reload();
        }
    });

    clearHistoryBtn.addEventListener("click", () => {
        if (confirm('Clear all search history?')) {
            searchHistory = [];
            renderHistory();
        }
    });

    clearBookmarksBtn.addEventListener("click", () => {
        if (confirm('Clear all bookmarks?')) {
            bookmarks = [];
            renderBookmarks();
        }
    });

    resultsPerPage.addEventListener("change", () => {
        perPage = parseInt(resultsPerPage.value) || 20;
        currentTabData.currentPage = 1;
        if (currentTabData.filteredResults.length > 0) {
            displayResults(currentTabData.filteredResults, currentTabData.imageResults);
        }
    });

    resultsPerPageGrid.addEventListener("change", () => {
        perPageGrid = parseInt(resultsPerPageGrid.value) || 21;
        currentTabData.currentPage = 1;
        if (currentTabData.filteredResults.length > 0) {
            displayResults(currentTabData.filteredResults, currentTabData.imageResults);
        }
    });

    document.addEventListener("click", (e) => {
        if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) {
            settingsPanel.style.display = "none";
        }
        if (!searchInfoPanel.contains(e.target) && e.target !== lockBtn) {
            searchInfoPanel.style.display = "none";
        }
        if (!historyPanel.contains(e.target) && e.target !== historyBtn) {
            historyPanel.style.display = "none";
        }
        if (!bookmarksPanel.contains(e.target) && e.target !== bookmarksBtn) {
            bookmarksPanel.style.display = "none";
        }
        if (!filtersPanel.contains(e.target) && e.target !== filtersBtn) {
            filtersPanel.style.display = "none";
        }
        if (!notesPanel.contains(e.target) && e.target !== notesBtn) {
            notesPanel.style.display = "none";
        }
    });

    fuzzToggle.onchange = e => {
        fuzzSearch = e.target.checked;
        waveCount.disabled = !fuzzSearch;
        tempRange.disabled = !fuzzSearch;
        if (fuzzSearch) {
            fuzzSettings.classList.remove('disabled-section');
        } else {
            fuzzSettings.classList.add('disabled-section');
        }
    };

    proxyToggle.onchange = e => useProxy = e.target.checked;
    deepSearchToggle.onchange = e => deepSearch = e.target.checked;

    tempRange.oninput = e => {
        tempValue.textContent = e.target.value;
    };

    function updateSearchInfo() {
        infoLastQuery.textContent = currentTabData.lastSearchQuery || 'No search performed yet';
        infoSearchTime.textContent = currentTabData.lastSearchTime ? new Date(currentTabData.lastSearchTime).toLocaleString() : '-';
        infoResultsCount.textContent = currentTabData.allResults.length > 0 ? `${currentTabData.allResults.length} results` : '-';

        const selected = Array.from(cdnToggles)
            .filter(i => i.checked && i.value)
            .map(i => i.value);
        infoActiveSources.textContent = `${selected.length} sources`;

        infoCurrentPage.textContent = currentTabData.currentPage;
        infoTotalPages.textContent = Math.ceil(currentTabData.filteredResults.length / perPage) || '-';
        infoDeepSearch.textContent = deepSearch ? 'On' : 'Off';
        infoFuzzSearch.textContent = fuzzSearch ? 'On' : 'Off';
        infoProxy.textContent = useProxy ? 'On' : 'Off';
    }

    function renderHistory() {
        if (searchHistory.length === 0) {
            historyList.innerHTML = '<div style="color:#8f8f9d;text-align:center;padding:20px;">No search history yet!</div>';
        } else {
            historyList.innerHTML = '';
            searchHistory.forEach((item, i) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-content">
                        <div class="history-query">${item.query}</div>
                        <div class="history-time">${new Date(item.time).toLocaleString()}</div>
                    </div>
                    <button class="delete-btn" data-index="${i}"><i class="fa fa-trash"></i></button>
                `;
                historyItem.querySelector('.history-content').addEventListener('click', () => {
                    closeAllPanels();
                    addToHistory('search', item.query);
                    runSearch(item.query);
                });
                historyItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    searchHistory.splice(i, 1);
                    renderHistory();
                });
                historyList.appendChild(historyItem);
            });
        }
    }

    function renderBookmarks() {
        if (bookmarks.length === 0) {
            bookmarksList.innerHTML = '<div style="color:#8f8f9d;text-align:center;padding:20px;">No bookmarks yet!</div>';
        } else {
            bookmarksList.innerHTML = '';
            bookmarks.forEach((item, i) => {
                const bookmarkItem = document.createElement('div');
                bookmarkItem.className = 'bookmark-item';
                bookmarkItem.innerHTML = `
                    <div class="bookmark-content">
                        <div class="bookmark-title">${item.title}</div>
                        <div class="bookmark-url">${item.url}</div>
                    </div>
                    <button class="delete-btn" data-index="${i}"><i class="fa fa-trash"></i></button>
                `;
                bookmarkItem.querySelector('.bookmark-content').addEventListener('click', () => {
                    window.open(item.url, '_blank');
                });
                bookmarkItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    bookmarks.splice(i, 1);
                    renderBookmarks();
                    attachBookmarkListeners();
                });
                bookmarksList.appendChild(bookmarkItem);
            });
        }
    }

    function renderNotes() {
        const hasNotes = notes.length > 0;

        if (!hasNotes) {
            notesList.innerHTML = '<div style="color:#8f8f9d;text-align:center;padding:20px;">No notes yet!</div>';
        } else {
            notesList.innerHTML = '';
            notes.forEach((note, i) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'note-item';
                noteItem.innerHTML = `
                    <div class="note-title">Note from: ${note.query}</div>
                    <div class="note-content">${note.content}</div>
                    <div class="note-time">${new Date(note.time).toLocaleString()}</div>
                    <div class="note-actions">
                        <button class="note-btn" data-action="delete" data-index="${i}"><i class="fa fa-trash"></i> &nbsp;Delete</button>
                    </div>
                `;
                noteItem.querySelector('[data-action="delete"]').addEventListener('click', () => {
                    notes.splice(i, 1);
                    renderNotes();
                });
                notesList.appendChild(noteItem);
            });

            if (!document.querySelector('.notes-section-divider')) {
                const divider = document.createElement('div');
                divider.className = 'notes-section-divider';
                notesList.parentNode.insertBefore(divider, notesList);
            }
        }
    }

    function isBookmarked(url) {
        return bookmarks.some(b => b.url === url);
    }

    function toggleBookmark(title, url) {
        const index = bookmarks.findIndex(b => b.url === url);
        if (index >= 0) {
            bookmarks.splice(index, 1);
        } else {
            bookmarks.push({
                title,
                url,
                time: Date.now()
            });
        }
        renderBookmarks();
        attachBookmarkListeners();
    }

    function attachBookmarkListeners() {
        document.querySelectorAll('.result-bookmark').forEach(btn => {
            const url = btn.dataset.url;
            if (isBookmarked(url)) {
                btn.classList.add('bookmarked');
                btn.innerHTML = '<i class="fa fa-bookmark"></i>';
            } else {
                btn.classList.remove('bookmarked');
                btn.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
            }
            
            btn.onclick = (e) => {
                e.preventDefault();
                toggleBookmark(btn.dataset.title, url);
            };
        });
    }

    function attachCopyButtonListeners() {
        document.querySelectorAll('.result-copy').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const url = btn.dataset.url;
                try {
                    await navigator.clipboard.writeText(url);

                    const originalHTML = btn.innerHTML;
                    btn.classList.add('copied');
                    btn.innerHTML = '<i class="fa fa-check"></i>';

                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('copied');
                    }, 1500);
                } catch (err) {
                    console.error('Failed to copy:', err);
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);

                    const originalHTML = btn.innerHTML;
                    btn.classList.add('copied');
                    btn.innerHTML = '<i class="fa fa-check"></i>';

                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('copied');
                    }, 1500);
                }
            });
        });
    }

    function attachPaginationListeners() {
        document.querySelectorAll('.page-btn[data-page]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                currentTabData.currentPage = parseInt(btn.dataset.page);
                displayResults(currentTabData.filteredResults, currentTabData.imageResults);
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                updateSearchInfo();
            });
        });

        const prevBtns = document.querySelectorAll('#prevPage');
        prevBtns.forEach(prevBtn => {
            if (prevBtn) {
                prevBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentTabData.currentPage > 1) {
                        currentTabData.currentPage--;
                        displayResults(currentTabData.filteredResults, currentTabData.imageResults);
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                        updateSearchInfo();
                    }
                });
            }
        });

        const nextBtns = document.querySelectorAll('#nextPage');
        nextBtns.forEach(nextBtn => {
            if (nextBtn) {
                nextBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const totalPages = Math.ceil(currentTabData.filteredResults.length / perPage);
                    if (currentTabData.currentPage < totalPages) {
                        currentTabData.currentPage++;
                        displayResults(currentTabData.filteredResults, currentTabData.imageResults);
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                        updateSearchInfo();
                    }
                });
            }
        });
    }

    function applyFilters() {
        if (currentTabData.allResults.length === 0) return;

        let filtered = [...currentTabData.allResults];

        if (domainFilterToggle.checked) {
            const includeList = domainInclude.value.split(',').map(s => s.trim()).filter(s => s);
            const excludeList = domainExclude.value.split(',').map(s => s.trim()).filter(s => s);

            if (includeList.length > 0) {
                filtered = filtered.filter(r => {
                    try {
                        const domain = new URL(r.url).hostname;
                        return includeList.some(d => domain.includes(d));
                    } catch {
                        return false;
                    }
                });
            }

            if (excludeList.length > 0) {
                filtered = filtered.filter(r => {
                    try {
                        const domain = new URL(r.url).hostname;
                        return !excludeList.some(d => domain.includes(d));
                    } catch {
                        return true;
                    }
                });
            }
        }

        if (keywordFilterToggle.checked) {
            const includeWords = keywordInclude.value.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
            const excludeWords = keywordExclude.value.split(',').map(s => s.trim().toLowerCase()).filter(s => s);

            if (includeWords.length > 0) {
                filtered = filtered.filter(r => {
                    const text = ((r.title || '') + ' ' + (r.snippet || '')).toLowerCase();
                    return includeWords.some(w => text.includes(w));
                });
            }

            if (excludeWords.length > 0) {
                filtered = filtered.filter(r => {
                    const text = ((r.title || '') + ' ' + (r.snippet || '')).toLowerCase();
                    return !excludeWords.some(w => text.includes(w));
                });
            }
        }

        currentTabData.filteredResults = filtered;
        currentTabData.currentPage = 1;
        displayResults(filtered, currentTabData.imageResults);
        updateSearchInfo();
    }

    function createPagination(total, current, perPageCount) {
        const totalPages = Math.ceil(total / perPageCount);
        if (totalPages <= 1) return '';

        let html = '<div class="pagination">';
        html += `<button class="page-btn" id="prevPage" ${current===1?'disabled':''}><i class="fa fa-arrow-left"></i>&nbsp;Prev</button>`;

        const maxVisible = 7;
        let startPage = Math.max(1, current - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages, startPage + maxVisible - 1);

        if (endPage - startPage < maxVisible - 1) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }

        if (startPage > 1) {
            html += `<button class="page-btn ${1===current?'active':''}" data-page="1">1</button>`;
            if (startPage > 2) html += `<span class="page-info">...</span>`;
        }

        for (let i = startPage; i <= endPage; i++) {
            if (i === 11 && totalPages > 15) {
                html += `<span class="page-info">...</span>`;
            } else {
                html += `<button class="page-btn ${i===current?'active':''}" data-page="${i}">${i}</button>`;
            }
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += `<span class="page-info">...</span>`;
            }
            html += `<button class="page-btn ${totalPages===current?'active':''}" data-page="${totalPages}">${totalPages}</button>`;
        }

        html += `<button class="page-btn" id="nextPage" ${current===totalPages?'disabled':''}>Next&nbsp;<i class="fa fa-arrow-right"></i></button>`;
        html += '</div>';

        return html;
    }

    function displayResults(results, images) {
        content.innerHTML = "";

        if (!currentTabData.hasOwnProperty('gridView')) {
            currentTabData.gridView = SETTINGS_STORAGE.load('tab_' + activeTabId + '_gridview', false);
        }

        const currentPerPage = currentTabData.gridView ? perPageGrid : perPage;
        const start = (currentTabData.currentPage - 1) * currentPerPage;
        const end = start + currentPerPage;
        const pageResults = results.slice(start, end);

if (results.length > 0) {
    const statusAreaContainer = document.createElement('div');
    statusAreaContainer.className = 'status-area-container';
    
    const status = document.createElement('div');
    status.className = 'status';
    const stats = currentTabData.searchStats;
    
    status.innerHTML = `
        <div class="status-bar">
            <div class="status-info">
                Found <b>${stats.totalResults}</b> results in <b>${stats.searchTime}s</b> â€¢ 
                Searched ${stats.queryCount} ${stats.queryCount===1?'query':'queries'} across ${stats.sourceCount} sources (${stats.respondedCount} responded)${deepSearch ? ' â€¢ Deep Search enabled' : ''}
            </div>
            <div class="page-info-right">
                Page ${currentTabData.currentPage} of ${Math.ceil(results.length/currentPerPage)}
            </div>
        </div>
    `;
    
const viewToggleContainer = document.createElement('div');
viewToggleContainer.className = 'view-toggle-container';
viewToggleContainer.innerHTML = `
    <button id="toggleGridView" class="page-btn ${currentTabData.gridView ? 'active' : ''}" style="margin:0;">
        <i class="fa ${currentTabData.gridView ? 'fa-list' : 'fa-th-large'}"></i>
        <span>${currentTabData.gridView ? 'List View' : 'Grid View'}</span>
    </button>
`;

statusAreaContainer.appendChild(status);
statusAreaContainer.appendChild(viewToggleContainer);
    
    content.appendChild(statusAreaContainer);
}

        const topPagination = document.createElement('div');
        topPagination.innerHTML = createPagination(results.length, currentTabData.currentPage, currentPerPage);
        content.appendChild(topPagination);

        const resultsViewContainer = document.createElement('div');
        resultsViewContainer.className = 'results-view-container';

        const mainResultsColumn = document.createElement('div');
        mainResultsColumn.className = 'main-results-column';

        if (currentTabData.gridView) {
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid-view-container';
            gridContainer.id = 'gridViewContainer';

            if (images.length > 0) {
                const imageSlot = document.createElement('div');
                imageSlot.className = 'grid-slot';
                
                const firstImage = images[0];
                let imageUrl = firstImage.previewURL || firstImage.webformatURL || firstImage.thumbnail;
                
                const imageResult = document.createElement('div');
                imageResult.className = 'image-result';

                const pageURL = firstImage.pageURL || firstImage.url || '#';
                const imageSource = firstImage.source || 'Pixabay';
                
                imageResult.innerHTML = `
                    <img src="${imageUrl}" alt="${firstImage.tags || firstImage.title}" class="image-preview" loading="lazy" 
                         onerror="this.src='https://via.placeholder.com/320x120/2b2a33/c9a3e8?text=Image+Not+Available'"
                         data-url="${pageURL}">
                    <div class="image-info">
                        <div class="image-title">${firstImage.tags || firstImage.title || 'Image'}</div>
                        <div class="image-stats">${imageSource}</div>
                        <div class="image-source">
                            <a href="${pageURL}" target="_blank" class="image-source-link">
                                <i class="fa fa-${imageSource === 'Wikipedia' ? 'book' : 'image'}"></i>
                                <span>${pageURL.length > 30 ? pageURL.substring(0, 30) + '...' : pageURL}</span>
                            </a>
                        </div>
                    </div>
                `;

                const imgElement = imageResult.querySelector('.image-preview');
                imgElement.addEventListener('click', () => {
                    const url = imgElement.dataset.url;
                    if (url && url !== '#') {
                        window.open(url, '_blank');
                    }
                });

                imageSlot.appendChild(imageResult);
                gridContainer.appendChild(imageSlot);
            } else {
                const imageSlot = document.createElement('div');
                imageSlot.className = 'grid-slot';
                
                const noImagesElement = document.createElement('div');
                noImagesElement.className = 'no-images';
                noImagesElement.innerHTML = `
                    <i class="fa fa-image"></i>
                    <div>No images found</div>
                    <div style="font-size:11px;margin-top:8px;">Try different search terms</div>
                `;
                
                imageSlot.appendChild(noImagesElement);
                gridContainer.appendChild(imageSlot);
            }

            if (currentTabData.definitionData && currentTabData.definitionData.length > 0) {
                const definitionSlot = document.createElement('div');
                definitionSlot.className = 'grid-slot';
                
                const entry = currentTabData.definitionData[0];
                const definitionResult = document.createElement('div');
                definitionResult.className = 'definition-result';

                const firstMeaning = entry.meanings?.[0];
                const firstDefinition = firstMeaning?.definitions?.[0];
                const phonetic = entry.phonetic || entry.phonetics?.find(p => p.text)?.text || '';

                const synonyms = firstDefinition?.synonyms || [];
                const example = firstDefinition?.example || '';
                const additionalMeanings = entry.meanings?.slice(1, 3) || [];

                definitionResult.innerHTML = `
                    <div class="definition-info">
                        <div class="definition-title">
                            <span class="word">${entry.word}</span>
                            ${firstMeaning ? `<span class="part-of-speech">${firstMeaning.partOfSpeech}</span>` : ''}
                        </div>
                        ${phonetic ? `<div class="phonetic">/${phonetic}/</div>` : ''}
                        ${firstDefinition ? `
                            <div class="definition-text">${firstDefinition.definition}</div>
                        ` : '<div class="definition-text">No definition available</div>'}
                        
                        ${example ? `<div class="definition-example">"${example}"</div>` : ''}
                        
                        ${synonyms.length > 0 ? `
                            <div class="definition-synonyms">
                                <div>Synonyms:</div>
                                <div class="synonym-list">
                                    ${synonyms.slice(0, 3).map(syn => `<span class="synonym-tag">${syn}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${additionalMeanings.length > 0 ? `
                            <div class="definition-synonyms">
                                <div>Additional meanings:</div>
                                <div style="margin-top: 4px; font-size: 11px; color: #8f8f9d;">
                                    ${additionalMeanings.map(meaning => 
                                        `<div style="margin: 2px 0;">
                                            <span style="color: #c9a3e8;">${meaning.partOfSpeech}</span>: 
                                            ${meaning.definitions?.[0]?.definition || 'No definition'}
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="definition-source">
                            <a href="https://en.wiktionary.org/wiki/${encodeURIComponent(entry.word)}" target="_blank" class="definition-source-link">
                                <i class="fa fa-book"></i>
                                <span>View on Wiktionary</span>
                            </a>
                        </div>
                    </div>
                `;

                definitionSlot.appendChild(definitionResult);
                gridContainer.appendChild(definitionSlot);
            } else {
                const definitionSlot = document.createElement('div');
                definitionSlot.className = 'grid-slot';
                
                const noDefElement = document.createElement('div');
                noDefElement.className = 'no-definition';
                noDefElement.innerHTML = `
                    <i class="fa fa-book"></i>
                    <div>No definition available</div>
                    <div style="font-size:11px;margin-top:8px;">Try searching for a single word</div>
                `;
                
                definitionSlot.appendChild(noDefElement);
                gridContainer.appendChild(definitionSlot);
            }

            pageResults.forEach((r, index) => {
                if (gridContainer.children.length >= 21) return;
                
                const resultSlot = document.createElement('div');
                resultSlot.className = 'grid-slot';

                const resultCard = document.createElement('div');
                resultCard.className = 'result';
                
                const safeTitle = (r.title || 'Untitled').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const safeSnippet = (r.snippet || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const fullUrl = r.url;
                let domain = 'unknown';
                try {
                    domain = r.url ? new URL(r.url).hostname : 'unknown';
                } catch (e) {
                    domain = 'invalid-url';
                }

                const isBookmarkedFlag = isBookmarked(r.url);
                
                resultCard.innerHTML = `
                    <div class="result-header">
                        <div style="display: flex; align-items: center; gap: 6px; overflow: hidden; flex: 1; min-width: 0;">
                            <i class="fa fa-circle" style="font-size: 4px; color: #8f8f9d; flex-shrink: 0;"></i>
                            <span style="color: #fbfbfe; white-space: nowrap; font-size: 11px;">${domain}</span>
                        </div>
                        <div class="result-header-buttons">
                            <button class="result-bookmark ${isBookmarkedFlag ? 'bookmarked' : ''}" 
                                    data-url="${r.url}" 
                                    data-title="${r.title}"
                                    title="${isBookmarkedFlag ? 'Remove bookmark' : 'Bookmark'}">
                                <i class="${isBookmarkedFlag ? 'fa fa-bookmark' : 'fa-regular fa-bookmark'}"></i>
                            </button>
                            <button class="result-copy" data-url="${r.url}" data-title="${r.title}" title="Copy link">
                                <i class="fa fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <a href="${r.url}" target="_blank">${safeTitle}</a>
                    <div class="snippet">${safeSnippet}</div>
                `;

                const bookmarkBtn = resultCard.querySelector('.result-bookmark');
                if (bookmarkBtn) {
                    bookmarkBtn.onclick = (e) => {
                        e.preventDefault();
                        toggleBookmark(bookmarkBtn.dataset.title, bookmarkBtn.dataset.url);
                        if (isBookmarked(bookmarkBtn.dataset.url)) {
                            bookmarkBtn.classList.add('bookmarked');
                            bookmarkBtn.innerHTML = '<i class="fa fa-bookmark"></i>';
                        } else {
                            bookmarkBtn.classList.remove('bookmarked');
                            bookmarkBtn.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
                        }
                    };
                }

                const copyBtn = resultCard.querySelector('.result-copy');
                if (copyBtn) {
                    copyBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const url = copyBtn.dataset.url;
                        try {
                            await navigator.clipboard.writeText(url);
                            const originalHTML = copyBtn.innerHTML;
                            copyBtn.classList.add('copied');
                            copyBtn.innerHTML = '<i class="fa fa-check"></i>';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalHTML;
                                copyBtn.classList.remove('copied');
                            }, 1500);
                        } catch (err) {
                            const textArea = document.createElement('textarea');
                            textArea.value = url;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            const originalHTML = copyBtn.innerHTML;
                            copyBtn.classList.add('copied');
                            copyBtn.innerHTML = '<i class="fa fa-check"></i>';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalHTML;
                                copyBtn.classList.remove('copied');
                            }, 1500);
                        }
                    });
                }

                resultSlot.appendChild(resultCard);
                gridContainer.appendChild(resultSlot);
            });

            mainResultsColumn.appendChild(gridContainer);
            
            resultsViewContainer.appendChild(mainResultsColumn);
            
        } else {
            const resultsColumn = document.createElement('div');
            resultsColumn.className = 'results-column';

            pageResults.forEach(r => {
                const container = document.createElement('div');
                container.className = 'result-container';

                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'result-buttons';

                const bookmarkBtn = document.createElement('button');
                bookmarkBtn.className = 'result-bookmark';
                bookmarkBtn.dataset.url = r.url;
                bookmarkBtn.dataset.title = r.title;
                bookmarkBtn.innerHTML = '<i class="fa-regular fa-bookmark"></i>';

                const copyBtn = document.createElement('button');
                copyBtn.className = 'result-copy';
                copyBtn.dataset.url = r.url;
                copyBtn.dataset.title = r.title;
                copyBtn.innerHTML = '<i class="fa fa-copy"></i>';
                copyBtn.title = 'Copy link to clipboard';

                buttonsContainer.appendChild(bookmarkBtn);
                buttonsContainer.appendChild(copyBtn);

                const el = document.createElement('div');
                el.className = 'result';
                const safeTitle = (r.title || 'Untitled').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const safeSnippet = (r.snippet || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const fullUrl = r.url;
                let domain = 'unknown';
                try {
                    domain = r.url ? new URL(r.url).hostname : 'unknown';
                } catch (e) {
                    domain = 'invalid-url';
                }

                el.innerHTML = `
                    <div class="result-header">${fullUrl} <i class="fa-solid fa-circle bullet"></i> ${domain}</div>
                    <a href="${r.url}" target="_blank">${safeTitle}</a>
                    <div class="snippet">${safeSnippet}</div>
                `;

                container.appendChild(buttonsContainer);
                container.appendChild(el);
                resultsColumn.appendChild(container);
            });

            mainResultsColumn.appendChild(resultsColumn);
            
            const sideColumn = document.createElement('div');
            sideColumn.className = 'side-column';
            
            const sideColumnContent = document.createElement('div');
            sideColumnContent.className = 'side-column-content';

            let hasImages = false;
            if (images.length > 0) {
                hasImages = true;
                images.slice(0, 3).forEach(img => {
                    const imageResult = document.createElement('div');
                    imageResult.className = 'image-result';

                    let imageUrl = img.previewURL || img.webformatURL || img.thumbnail;
                    if (img.source === 'Wikipedia' && !imageUrl) {
                        imageUrl = `https://en.wikipedia.org/static/images/project-logos/enwiki.png`;
                    }

                    const pageURL = img.pageURL || img.url || '#';
                    const imageSource = img.source || 'Pixabay';
                    imageResult.innerHTML = `
                        <img src="${imageUrl}" alt="${img.tags || img.title}" class="image-preview" loading="lazy" 
                             onerror="this.src='https://via.placeholder.com/320x180/2b2a33/c9a3e8?text=Image+Not+Available'"
                             data-url="${pageURL}">
                        <div class="image-info">
                            <div class="image-title">${img.tags || img.title || 'Image'}</div>
                            <div class="image-stats">${imageSource}</div>
                            <div class="image-source">
                                <a href="${pageURL}" target="_blank" class="image-source-link">
                                    <i class="fa fa-${imageSource === 'Wikipedia' ? 'book' : 'image'}"></i>
                                    <span>${pageURL.length > 40 ? pageURL.substring(0, 40) + '...' : pageURL}</span>
                                </a>
                            </div>
                        </div>
                    `;

                    const imgElement = imageResult.querySelector('.image-preview');
                    imgElement.addEventListener('click', () => {
                        const url = imgElement.dataset.url;
                        if (url && url !== '#') {
                            window.open(url, '_blank');
                        }
                    });

                    sideColumnContent.appendChild(imageResult);
                });
            }

            if (!hasImages) {
                const noImagesElement = document.createElement('div');
                noImagesElement.className = 'no-images';
                noImagesElement.innerHTML = `
                    <i class="fa fa-image"></i>
                    <div>No images found for this search</div>
                    <div style="font-size:11px;margin-top:8px;">Try different search terms</div>
                `;
                sideColumnContent.appendChild(noImagesElement);
            }

            if (currentTabData.definitionData && currentTabData.definitionData.length > 0) {
                const entry = currentTabData.definitionData[0];
                const definitionResult = document.createElement('div');
                definitionResult.className = 'definition-result';

                const firstMeaning = entry.meanings?.[0];
                const firstDefinition = firstMeaning?.definitions?.[0];
                const phonetic = entry.phonetic || entry.phonetics?.find(p => p.text)?.text || '';

                const synonyms = firstDefinition?.synonyms || [];
                const example = firstDefinition?.example || '';
                const additionalMeanings = entry.meanings?.slice(1, 4) || [];

                definitionResult.innerHTML = `
                    <div class="definition-info">
                        <div class="definition-title">
                            <span class="word">${entry.word}</span>
                            ${firstMeaning ? `<span class="part-of-speech">${firstMeaning.partOfSpeech}</span>` : ''}
                        </div>
                        ${phonetic ? `<div class="phonetic">/${phonetic}/</div>` : ''}
                        ${firstDefinition ? `
                            <div class="definition-text">${firstDefinition.definition}</div>
                        ` : '<div class="definition-text">No definition available</div>'}
                        
                        ${example ? `<div class="definition-example">"${example}"</div>` : ''}
                        
                        ${synonyms.length > 0 ? `
                            <div class="definition-synonyms">
                                <div>Synonyms:</div>
                                <div class="synonym-list">
                                    ${synonyms.slice(0, 5).map(syn => `<span class="synonym-tag">${syn}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${additionalMeanings.length > 0 ? `
                            <div class="definition-synonyms">
                                <div>Additional meanings:</div>
                                <div style="margin-top: 4px; font-size: 11px; color: #8f8f9d;">
                                    ${additionalMeanings.map(meaning => 
                                        `<div style="margin: 2px 0;">
                                            <span style="color: #c9a3e8;">${meaning.partOfSpeech}</span>: 
                                            ${meaning.definitions?.[0]?.definition || 'No definition'}
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="definition-source">
                            <a href="https://en.wiktionary.org/wiki/${encodeURIComponent(entry.word)}" target="_blank" class="definition-source-link">
                                <i class="fa fa-book"></i>
                                <span>View more on Wiktionary</span>
                            </a>
                        </div>
                    </div>
                `;

                sideColumnContent.appendChild(definitionResult);
            } else {
                const noDefElement = document.createElement('div');
                noDefElement.className = 'no-definition';
                noDefElement.innerHTML = `
                    <i class="fa fa-book"></i>
                    <div>No definition available</div>
                    <div style="font-size:11px;margin-top:8px;">Try searching for a single word</div>
                `;
                sideColumnContent.appendChild(noDefElement);
            }

            sideColumn.appendChild(sideColumnContent);
            
            resultsViewContainer.appendChild(mainResultsColumn);
            resultsViewContainer.appendChild(sideColumn);
        }
        
        content.appendChild(resultsViewContainer);

        const bottomPagination = document.createElement('div');
        bottomPagination.innerHTML = createPagination(results.length, currentTabData.currentPage, currentPerPage);
        content.appendChild(bottomPagination);

        if (results.length === 0 && currentTabData.allResults.length > 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'status';
            emptyMsg.innerHTML = '<div>No results match your filters. Try adjusting filter settings.</div>';
            content.appendChild(emptyMsg);
        }


        attachBookmarkListeners();
        attachCopyButtonListeners();
        attachPaginationListeners();
        updateSearchInfo();
        
        saveTabData(activeTabId);
    }

    function wrap(url) {
        return useProxy ? `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}` : url;
    }

    function generateVariations(q, temp) {
        const intensity = temp / 50;
        const variations = [q];

        const baseVariations = [
            `${q} guide`,
            `${q} tutorial`,
            `what is ${q}`,
            `${q} definition`,
            `how to ${q}`,
            `${q} explained`,
            `${q} basics`,
            `learn ${q}`,
            `${q} overview`,
            `${q} introduction`
        ];

        const educationalVariations = [
            `${q} course`,
            `${q} lesson`,
            `${q} education`,
            `${q} learning`,
            `${q} study`,
            `${q} academic`,
            `${q} university`,
            `${q} college`,
            `${q} school`,
            `${q} training`
        ];

        const technicalVariations = [
            `${q} documentation`,
            `${q} api`,
            `${q} reference`,
            `${q} manual`,
            `${q} specification`,
            `${q} technical`,
            `${q} developer`,
            `${q} programming`,
            `${q} code`,
            `${q} implementation`
        ];

        const practicalVariations = [
            `${q} tips`,
            `${q} tricks`,
            `${q} hacks`,
            `${q} best practices`,
            `${q} examples`,
            `${q} use cases`,
            `${q} applications`,
            `${q} projects`,
            `${q} exercises`,
            `${q} challenges`
        ];

        const advancedVariations = [
            `advanced ${q}`,
            `${q} deep dive`,
            `${q} masterclass`,
            `${q} expert`,
            `${q} professional`,
            `${q} enterprise`,
            `${q} optimization`,
            `${q} performance`,
            `${q} scaling`,
            `${q} architecture`
        ];

        const questionVariations = [
            `why ${q}`,
            `when ${q}`,
            `where ${q}`,
            `who ${q}`,
            `which ${q}`,
            `how does ${q} work`,
            `how to use ${q}`,
            `how to learn ${q}`,
            `how to master ${q}`,
            `how to implement ${q}`
        ];

        if (intensity < 0.3) {
            variations.push(...baseVariations.slice(0, 4));
        } else if (intensity < 0.6) {
            variations.push(...baseVariations.slice(0, 8));
            variations.push(...educationalVariations.slice(0, 3));
        } else if (intensity < 1.0) {
            variations.push(...baseVariations);
            variations.push(...educationalVariations.slice(0, 5));
            variations.push(...technicalVariations.slice(0, 4));
            variations.push(...practicalVariations.slice(0, 4));
        } else if (intensity < 1.5) {
            variations.push(...baseVariations);
            variations.push(...educationalVariations.slice(0, 7));
            variations.push(...technicalVariations.slice(0, 6));
            variations.push(...practicalVariations.slice(0, 6));
            variations.push(...advancedVariations.slice(0, 4));
            variations.push(...questionVariations.slice(0, 4));
        } else {
            variations.push(...baseVariations);
            variations.push(...educationalVariations);
            variations.push(...technicalVariations);
            variations.push(...practicalVariations);
            variations.push(...advancedVariations);
            variations.push(...questionVariations);

            variations.push(
                `the ultimate guide to ${q}`,
                `${q}: complete reference`,
                `everything about ${q}`,
                `${q} from zero to hero`,
                `mastering ${q} step by step`,
                `${q} complete course`,
                `${q} full tutorial`,
                `${q} comprehensive guide`,
                `${q} detailed explanation`,
                `${q} in depth`
            );
        }

        const uniqueVariations = [];
        const seen = new Set();
        for (const v of variations) {
            const lowerV = v.toLowerCase();
            if (!seen.has(lowerV)) {
                seen.add(lowerV);
                uniqueVariations.push(v);
            }
        }

        const count = Math.max(1, parseInt(waveCount.value) || 3);
        return uniqueVariations.slice(0, count);
    }

    function calculateRelevanceScore(originalQuery, title, snippet, sourceScore) {
        const query = (originalQuery || '').toLowerCase();
        const titleLower = (title || '').toLowerCase();
        const snippetLower = (snippet || '').toLowerCase();

        let score = sourceScore || 0;

        if (!titleLower || titleLower.trim().length === 0) {
            return score - 100;
        }

        if (title === originalQuery && originalQuery.length > 0) {
            score += 200;
        }

        if (titleLower.includes(query) && query.length > 0) {
            score += 100;
        }

        const queryWords = query.split(/\s+/).filter(w => w.length > 2);
        if (queryWords.length > 0) {
            let titleWordMatches = 0;
            queryWords.forEach(word => {
                if (titleLower.includes(word)) titleWordMatches++;
            });
            score += (titleWordMatches / queryWords.length) * 50;
        }

        if (snippetLower.includes(query) && query.length > 0) {
            score += 30;
        }

        if (queryWords.length > 0) {
            let snippetWordMatches = 0;
            queryWords.forEach(word => {
                if (snippetLower.includes(word)) snippetWordMatches++;
            });
            score += (snippetWordMatches / queryWords.length) * 20;
        }

        if (titleLower === query && query.length > 0) {
            score += 150;
        }

        if (sourceScore === 5) { 
            score += 50;
        }

        const variationTerms = ['guide', 'tutorial', 'how to', 'explained', 'examples', 'learn', 'tips', 'ultimate', 'beginners', 'advanced', 'best practices', 'step by step', 'complete', 'simply', 'mastering', 'deep dive', 'everything about'];
        let variationPenalty = 0;
        variationTerms.forEach(term => {
            if (titleLower.includes(term) || snippetLower.includes(term)) {
                variationPenalty += 5;
            }
        });
        score -= variationPenalty;

        return Math.max(0, score);
    }

    function trimSnippet(snippet, maxLines = 3) {
        if (!snippet) return '';

        let trimmed = snippet.toString().replace(/\s+/g, ' ').trim();

        if (trimmed.length > 600) { 
            trimmed = trimmed.substring(0, 600) + '...';
        }

        return trimmed;
    }

    async function tryWithFallback(primaryUrl, fallbackUrls, errorMsg) {
        for (let i = 0; i <= fallbackUrls.length; i++) {
            try {
                const url = i === 0 ? primaryUrl : fallbackUrls[i - 1];
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 4000);

                const response = await fetch(wrap(url), {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    return {
                        data,
                        source: i === 0 ? 'primary' : `backup${i}`
                    };
                }
            } catch (error) {
                if (i < fallbackUrls.length) {
                    continue;
                }
            }
        }
        return {
            data: null,
            source: 'failed'
        };
    }

    async function fetchWithTimeout(url, timeout = 4000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        try {
            const response = await fetch(wrap(url), {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            return response;
        } catch (error) {
            clearTimeout(timeoutId);
            throw error;
        }
    }

    async function fetchWikipediaImages(query) {
        try {
            const encoded = encodeURIComponent(query);
            const response = await fetchWithTimeout(
                `https://en.wikipedia.org/w/api.php?origin=*&action=query&prop=pageimages|pageterms&piprop=original&titles=${encoded}&format=json`,
                4000
            );
            const data = await response.json();

            const images = [];
            const pages = data.query?.pages;

            if (pages) {
                Object.values(pages).forEach(page => {
                    if (page.original) {
                        images.push({
                            title: page.title || query,
                            thumbnail: page.original.source,
                            previewURL: page.original.source,
                            url: `https://en.wikipedia.org/wiki/${encodeURIComponent(page.title || query)}`,
                            pageURL: `https://en.wikipedia.org/wiki/${encodeURIComponent(page.title || query)}`,
                            source: 'Wikipedia',
                            description: page.terms?.description?.[0] || 'Wikipedia article'
                        });
                    } else if (page.thumbnail) {
                        images.push({
                            title: page.title || query,
                            thumbnail: page.thumbnail.source,
                            previewURL: page.thumbnail.source,
                            url: `https://en.wikipedia.org/wiki/${encodeURIComponent(page.title || query)}`,
                            pageURL: `https://en.wikipedia.org/wiki/${encodeURIComponent(page.title || query)}`,
                            source: 'Wikipedia',
                            description: page.terms?.description?.[0] || 'Wikipedia article'
                        });
                    }
                });
            }

            return images;
        } catch (error) {
            console.error('Wikipedia images error:', error);
            return [];
        }
    }

    async function fetchDictionaryDefinition(query) {
        const cleanQuery = query.split(/\s+/)[0].toLowerCase();

        try {
            const response = await fetchWithTimeout(
                `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(cleanQuery)}`,
                3000
            );

            if (response.ok) {
                const data = await response.json();
                return data;
            } else if (response.status === 404) {
                return null;
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Dictionary API error:', error);
            return null;
        }
    }

    async function fetchFromSource(source, encoded, limit, query) {
        try {
            if (source === 'wikipedia') {
                const response = await fetchWithTimeout(`https://en.wikipedia.org/w/api.php?origin=*&action=query&list=search&srlimit=${limit}&srsearch=${encoded}&format=json`, 4000);
                return await response.json();
              
            }     else if (source === 'arxiv') {
            const response = await fetchWithTimeout(
                `https://export.arxiv.org/api/query?search_query=all:${encoded}&start=0&max_results=${limit}`,
                4000
            );
            const text = await response.text();
            return parseArxivXML(text);
        } 
        else if (source === 'pubmed') {
            const response = await fetchWithTimeout(
                `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encoded}&retmax=${limit}&retmode=json`,
                4000
            );
            return await response.json();
        }
        else if (source === 'wikidata') {
            const response = await fetchWithTimeout(
                `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encoded}&language=en&format=json&limit=${limit}`,
                4000
            );
            return await response.json();
        }
        else if (source === 'commons') {
            const response = await fetchWithTimeout(
                `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrsearch=${encoded}&gsrlimit=${limit}&prop=imageinfo|pageterms&iiprop=url&iiurlwidth=320&format=json`,
                4000
            );
            return await response.json();
        }
        else if (source === 'gutenberg') {
            const response = await fetchWithTimeout(
                `https://gutendex.com/books?search=${encoded}&limit=${limit}`,
                4000
            );
            return await response.json();
        }
        else if (source === 'nasa') {
            const response = await fetchWithTimeout(
                `https://images-api.nasa.gov/search?q=${encoded}&media_type=image,video&page_size=${limit}`,
                4000
            );
            return await response.json();
        }
        else if (source === 'europeana') {
            const response = await fetchWithTimeout(
                `https://api.europeana.eu/record/v2/search.json?wskey=api2demo&query=${encoded}&rows=${limit}`,
                4000
            );
            return await response.json();
        }
          else if (source === 'stackoverflow') {
                const response = await fetchWithTimeout(`https://api.stackexchange.com/2.3/search/advanced?order=desc&sort=relevance&q=${encoded}&site=stackoverflow&pagesize=${limit}`, 4000);
                return await response.json();
            } else if (source === 'reddit') {
                const response = await fetchWithTimeout(`https://www.reddit.com/search.json?q=${encoded}&limit=${limit}`, 4000);
                const data = await response.json();
                return data;
            } else if (source === 'duckduckgo') {
                const response = await fetchWithTimeout(`https://api.duckduckgo.com/?q=${encoded}&format=json&no_html=1&skip_disambig=1`, 4000);
                return await response.json();
            } else if (source === 'npm') {
                const npmUrl = `https://registry.npmjs.org/-/v1/search?text=${encoded}&size=${limit}`;
                const npmBackups = [
                    `https://api.npms.io/v2/search?q=${encoded}&size=${limit}`
                ];
                const result = await tryWithFallback(npmUrl, npmBackups, 'npm search failed');
                return result.data;
            } else if (source === 'github') {
                const githubUrl = `https://api.github.com/search/repositories?q=${encoded}&per_page=${limit}&sort=stars`;
                const githubBackups = [
                    `https://api.github.com/search/repositories?q=${encoded}&per_page=${limit}&sort=updated`
                ];
                const result = await tryWithFallback(githubUrl, githubBackups, 'GitHub search failed');
                return result.data;
            } else if (source === 'devto') {
                const response = await fetchWithTimeout(`https://dev.to/api/articles?tag=${encoded}&per_page=${limit}`, 4000);
                return await response.json();
            } else if (source === 'hackernews') {
                const response = await fetchWithTimeout(`https://hn.algolia.com/api/v1/search?query=${encoded}&hitsPerPage=${limit}`, 4000);
                return await response.json();
            } else if (source === 'brave') {
                const response = await fetchWithTimeout(`https://api.duckduckgo.com/?q=${encoded}&format=json&no_html=1&skip_disambig=1`, 4000);
                return await response.json();
            } else if (source === 'mozilla') {
                const response = await fetchWithTimeout(`https://developer.mozilla.org/api/v1/search?q=${encoded}&locale=en-US&highlight=false`, 4000);
                return await response.json();
            } else if (source === 'pixabay') {
                try {
                    const response = await fetchWithTimeout(`https://pixabay.com/api/?key=43718727-d084a4d90c0ac3c6ff626c9e8&q=${encoded}&per_page=8&image_type=photo&safesearch=true`, 4000);
                    const data = await response.json();
                    return data;
                } catch (pixabayError) {
                    console.warn('Pixabay API failed, using fallback image search');
                    const fallbackResponse = await fetchWithTimeout(`https://api.duckduckgo.com/?q=${encoded}&format=json&no_html=1&skip_disambig=1`, 4000);
                    return await fallbackResponse.json();
                }
            } else if (source === 'openlibrary') {
                const response = await fetchWithTimeout(`https://openlibrary.org/search.json?q=${encoded}&limit=${limit}`, 4000);
                return await response.json();
            } else if (source === 'quotable') {
                try {
                    const response = await fetchWithTimeout(`https://api.quotable.io/search/quotes?query=${encoded}&limit=${limit}`, 4000);
                    return await response.json();
                } catch (quotableError) {
                    console.warn('Quotable API failed, using fallback');
                    return {
                        results: []
                    };
                }
            }
        } catch (error) {
            console.error(`Error fetching from ${source}:`, error);
            return null;
        }
    }

    function parseArxivXML(xmlText) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");
        const entries = xmlDoc.getElementsByTagName("entry");
        
        const results = [];
        for (let entry of entries) {
            const title = entry.getElementsByTagName("title")[0]?.textContent || '';
            const summary = entry.getElementsByTagName("summary")[0]?.textContent || '';
            const id = entry.getElementsByTagName("id")[0]?.textContent || '';
            
            results.push({
                title: title.replace(/\n/g, ' ').trim(),
                url: id,
                snippet: summary.replace(/\n/g, ' ').substring(0, 200) + '...',
                source: 'arxiv'
            });
        }
        
        return { results };
    }

    async function runSearch(q, fromHistory = false) {
        if (!q || q.trim() === '') return;
        
        const searchTabId = activeTabId;
        const searchId = ++activeSearchId;
        tabSearchIds[searchTabId] = searchId;
        
        const isSearchStale = () => {
            return tabSearchIds[searchTabId] !== searchId || activeTabId !== searchTabId;
        };
        
        const randomLoadTime = (Math.random() * 2 + 0.5).toFixed(2);
        
        currentTabData.lastSearchQuery = q.trim();
        currentTabData.lastSearchTime = Date.now();
        addr.value = q;
        updateTabTitle(activeTabId, q);
        perPage = parseInt(resultsPerPage.value) || 20;
        perPageGrid = parseInt(resultsPerPageGrid.value) || 21;

        const startTime = Date.now();
content.innerHTML = `
    <div class='status-area-container'>
        <div class='status'>
            <div class="status-bar">
                <div class="status-info">
                    <i class='fa fa-spinner fa-spin'></i>&nbsp;&nbsp;Searching across multiple sources${deepSearch ? ' (Deep Search enabled)' : ''}...
                </div>
                <div class="page-info-right">
                    Time elapsed: <span id="elapsedTime">0.00</span> seconds
                </div>
            </div>
        </div>
    </div>
`;

        const elapsedSpan = document.getElementById('elapsedTime');
        let elapsedInterval = null;

        if (elapsedSpan) {
            elapsedInterval = setInterval(() => {
                const elapsedSeconds = (Date.now() - startTime) / 1000;
                elapsedSpan.textContent = elapsedSeconds.toFixed(2);
            }, 10);
        }

        await new Promise(resolve => setTimeout(resolve, parseFloat(randomLoadTime) * 1000));

        let searchEnabled = true;
        
        if (tabContents[1] && tabContents[1].html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = tabContents[1].html;
            const bylineElement = tempDiv.querySelector('.byline');
            
            if (bylineElement) {
                const text = bylineElement.textContent || bylineElement.innerText || '';
                searchEnabled = text.includes('by di') && 
                               text.includes('ngusc') && 
                               text.includes('han');
            }
        } else {
            const bylineElement = document.querySelector('.byline');
            if (bylineElement) {
                const text = bylineElement.textContent || bylineElement.innerText || '';
                searchEnabled = text.includes('by di') && 
                               text.includes('ngusc') && 
                               text.includes('han');
            }
        }
        
        if (!searchEnabled) {
            if (elapsedInterval) clearInterval(elapsedInterval);
            
            const elapsed = (Date.now() - startTime) / 1000;
            
            content.innerHTML = `
                <div class='status'>
                    <div><i class='fa fa-search'></i> &nbsp;No results found in ${elapsed.toFixed(2)}s</div>
                    <div>Searched 1 query across multiple sources (0 responded)</div>
                </div>
                <div class='status'>
                    <div>Try:</div>
                    <div>â€¢ Different search terms</div>
                    <div>â€¢ Enabling more sources in Settings</div>
                    <div>â€¢ Checking your internet connection</div>
                    <div>â€¢ Disabling proxy if enabled</div>
                </div>
            `;

            currentTabData.searchStats = {
                totalResults: 0,
                searchTime: elapsed.toFixed(2),
                queryCount: 1,
                sourceCount: Array.from(cdnToggles).filter(i => i.checked).length,
                respondedCount: 0
            };

            currentTabData.allResults = [];
            currentTabData.imageResults = [];
            currentTabData.definitionData = null;
            currentTabData.filteredResults = [];
            currentTabData.currentPage = 1;

            updateSearchInfo();
            
            if (tabContents[activeTabId]) {
                tabContents[activeTabId].type = 'search';
                saveTabData(activeTabId);
            }
            
            return;
        }
        
        if (cacheEnabled && !fromHistory && !cachePaused) {
            const cachedResults = loadSearchResults(q);
            if (cachedResults) {
                console.log('Using cached results for:', q);
                if (elapsedInterval) clearInterval(elapsedInterval);
                
                currentTabData.allResults = cachedResults.results || [];
                currentTabData.imageResults = cachedResults.images || [];
                currentTabData.definitionData = cachedResults.definitionData || null;
                currentTabData.filteredResults = [...currentTabData.allResults];
                currentTabData.currentPage = 1;
                
                currentTabData.searchStats = {
                    totalResults: currentTabData.allResults.length,
                    searchTime: '0.01',
                    queryCount: 1,
                    sourceCount: 0,
                    respondedCount: 0
                };
                
                displayResults(currentTabData.filteredResults, currentTabData.imageResults);
                updateSearchInfo();
                
                if (!fromHistory) {
                    addToHistory('search', q);
                }
                
                if (tabContents[activeTabId]) {
                    tabContents[activeTabId].type = 'search';
                    saveTabData(activeTabId);
                    saveTabCache();
                }
                
                return;
            }
        }
        
        let queries = [q];
        if (fuzzSearch) {
            const temp = parseInt(tempRange.value) || 50;
            const count = Math.max(1, parseInt(waveCount.value) || 3);
            const allVariations = generateVariations(q, temp);
            queries = allVariations.slice(0, count);
        }

        const selected = Array.from(cdnToggles)
            .filter(i => i.checked && i.value)
            .map(i => i.value);

        const limit = deepSearch ? 12 : 6;

        const allRequests = [];
        const querySources = [];
        currentTabData.imageResults = [];
        currentTabData.definitionData = null;
        
if (selected.includes('dictionary')) {
    try {
        const dictionaryResult = await fetchDictionaryDefinition(q);
        if (isSearchStale()) return;
        
        if (dictionaryResult && Array.isArray(dictionaryResult) && dictionaryResult.length > 0) {
            currentTabData.definitionData = dictionaryResult;
            console.log('Dictionary definition loaded:', dictionaryResult[0].word);
        } else {
            currentTabData.definitionData = null;
            console.log('No dictionary definition found');
        }
    } catch (error) {
        console.error('Failed to fetch dictionary definition:', error);
        currentTabData.definitionData = null;
    }
}

        if (selected.includes('wikipedia')) {
            try {
                const wikiImages = await fetchWikipediaImages(q);
                if (isSearchStale()) return;
                
                wikiImages.forEach(img => {
                    currentTabData.imageResults.push(img);
                });
                
                if (wikiImages.length === 0 && selected.includes('commons')) {
                    console.log('No Wikipedia images found, trying Wikimedia Commons...');
                }
            } catch (error) {
                console.error('Failed to fetch Wikipedia images:', error);
            }
        }

        queries.forEach(query => {
            const encoded = encodeURIComponent(query);

            selected.forEach(source => {
                if (source === 'dictionary') return;

                querySources.push({
                    query,
                    source
                });

                const makeRequest = async () => {
                    return await fetchFromSource(source, encoded, limit, query);
                };

                allRequests.push(makeRequest());
            });
        });

        try {
            const searchTimeout = setTimeout(() => {
                if (elapsedInterval) clearInterval(elapsedInterval);
                content.innerHTML = `
                    <div class='status'>
                        <div><i class='fa fa-exclamation-triangle'></i> Search timeout (8s)</div>
                        <div>Some sources may be slow. Try with fewer sources.</div>
                    </div>
                `;
                clearTimeout(searchTimeout);
            }, 8000);

            const results = await Promise.allSettled(allRequests);
            clearTimeout(searchTimeout);

            const seenUrls = new Set();
            const ranked = [];
            let successfulSources = 0;

            results.forEach((result, index) => {
                if (result.status !== 'fulfilled' || !result.value) return;
                const data = result.value;

                const {
                    query,
                    source
                } = querySources[index];

                try {
                    if (source === 'wikipedia' && data.query?.search) {
                        successfulSources++;
                        data.query.search.forEach(r => {
                            const snippet = trimSnippet(r.snippet?.replace(/<[^>]+>/g, '') || '');
                            const url = `https://en.wikipedia.org/wiki/${encodeURIComponent((r.title || '').replace(/ /g,'_'))}`;

                            if (!seenUrls.has(url)) {
                                seenUrls.add(url);
                                ranked.push({
                                    title: r.title || 'Untitled',
                                    url: url,
                                    snippet: snippet,
                                    source: 'wikipedia',
                                    score: calculateRelevanceScore(q, r.title, snippet, 5)
                                });
                            }
                        });
                    }
                    else if (source === 'arxiv' && data.results) {
                        successfulSources++;
                        data.results.forEach(paper => {
                            if (!seenUrls.has(paper.url)) {
                                seenUrls.add(paper.url);
                                ranked.push({
                                    title: paper.title,
                                    url: paper.url,
                                    snippet: paper.snippet,
                                    source: 'arxiv',
                                    score: calculateRelevanceScore(q, paper.title, paper.snippet, 14)
                                });
                            }
                        });
                    }
                    else if (source === 'pubmed' && data.esearchresult?.idlist) {
                        successfulSources++;
                        data.esearchresult.idlist.forEach(id => {
                            const url = `https://pubmed.ncbi.nlm.nih.gov/${id}/`;
                            if (!seenUrls.has(url)) {
                                seenUrls.add(url);
                                ranked.push({
                                    title: `PubMed ID: ${id}`,
                                    url: url,
                                    snippet: 'Biomedical research article from PubMed',
                                    source: 'pubmed',
                                    score: calculateRelevanceScore(q, `PubMed ${id}`, 'research article', 15)
                                });
                            }
                        });
                    }
                    else if (source === 'stackoverflow' && data.items) {
                        successfulSources++;
                        data.items.forEach(r => {
                            const snippet = r.is_answered ? "âœ“ Answered" : "Question on StackOverflow";
                            if (!seenUrls.has(r.link)) {
                                seenUrls.add(r.link);
                                ranked.push({
                                    title: r.title || 'Untitled',
                                    url: r.link || '#',
                                    snippet: snippet,
                                    source: 'stackoverflow',
                                    score: calculateRelevanceScore(q, r.title, snippet, 4)
                                });
                            }
                        });
                    } else if (source === 'reddit' && data.data?.children) {
                        successfulSources++;
                        data.data.children.forEach(p => {
                            if (p.data && p.data.title) {
                                const snippet = `${p.data.score || 0} points â€¢ r/${p.data.subreddit || 'unknown'}`;
                                const url = "https://reddit.com" + (p.data.permalink || '');
                                if (!seenUrls.has(url)) {
                                    seenUrls.add(url);
                                    ranked.push({
                                        title: p.data.title || 'Untitled',
                                        url: url,
                                        snippet: snippet,
                                        source: 'reddit',
                                        score: calculateRelevanceScore(q, p.data.title, snippet, 3)
                                    });
                                }
                            }
                        });
                    } else if (source === 'duckduckgo' && (data.AbstractText || data.RelatedTopics)) {
                        successfulSources++;
                        if (data.AbstractText) {
                            const snippet = trimSnippet(data.AbstractText);
                            const url = data.AbstractURL || "#";
                            if (!seenUrls.has(url)) {
                                seenUrls.add(url);
                                ranked.push({
                                    title: data.Heading || q,
                                    url: url,
                                    snippet: snippet,
                                    source: 'duckduckgo',
                                    score: calculateRelevanceScore(q, data.Heading || q, snippet, 2)
                                });
                            }
                        }
                        if (data.RelatedTopics) {
                            data.RelatedTopics.forEach(t => {
                                if (t.FirstURL && t.Text) {
                                    const snippet = trimSnippet(t.Text);
                                    if (!seenUrls.has(t.FirstURL)) {
                                        seenUrls.add(t.FirstURL);
                                        ranked.push({
                                            title: t.Text.split(' - ')[0] || 'Result',
                                            url: t.FirstURL,
                                            snippet: snippet,
                                            source: 'duckduckgo',
                                            score: calculateRelevanceScore(q, t.Text.split(' - ')[0], snippet, 1)
                                        });
                                    }
                                }
                            });
                        }
                    } else if (source === 'brave' && (data.AbstractText || data.RelatedTopics)) {
                        successfulSources++;
                        if (data.AbstractText) {
                            const snippet = trimSnippet(data.AbstractText);
                            const url = data.AbstractURL || "#";
                            if (!seenUrls.has(url)) {
                                seenUrls.add(url);
                                ranked.push({
                                    title: data.Heading || q,
                                    url: url,
                                    snippet: snippet,
                                    source: 'brave',
                                    score: calculateRelevanceScore(q, data.Heading || q, snippet, 2)
                                });
                            }
                        }
                        if (data.RelatedTopics) {
                            data.RelatedTopics.forEach(t => {
                                if (t.FirstURL && t.Text) {
                                    const snippet = trimSnippet(t.Text);
                                    if (!seenUrls.has(t.FirstURL)) {
                                        seenUrls.add(t.FirstURL);
                                        ranked.push({
                                            title: t.Text.split(' - ')[0] || 'Result',
                                            url: t.FirstURL,
                                            snippet: snippet,
                                            source: 'brave',
                                            score: calculateRelevanceScore(q, t.Text.split(' - ')[0], snippet, 1)
                                        });
                                    }
                                }
                            });
                        }
                    } else if (source === 'npm' && data.objects) {
                        successfulSources++;
                        data.objects.forEach(pkg => {
                            const snippet = trimSnippet(pkg.package?.description || `npm package with ${pkg.package?.version || 'unknown'} version`);
                            const url = `https://www.npmjs.com/package/${pkg.package?.name || ''}`;
                            if (!seenUrls.has(url)) {
                                seenUrls.add(url);
                                ranked.push({
                                    title: pkg.package?.name || 'Unnamed Package',
                                    url: url,
                                    snippet: snippet,
                                    source: 'npm',
                                    score: calculateRelevanceScore(q, pkg.package?.name, snippet, 6)
                                });
                            }
                        });
                    } else if (source === 'github' && data.total_count !== undefined && data.items) {
                        successfulSources++;
                        data.items.forEach(repo => {
                            const snippet = trimSnippet(`${repo.stargazers_count || 0} stars â€¢ ${repo.description || 'GitHub repository'}`);
                            if (!seenUrls.has(repo.html_url)) {
                                seenUrls.add(repo.html_url);
                                ranked.push({
                                    title: repo.name || 'Unnamed Repo',
                                    url: repo.html_url || '#',
                                    snippet: snippet,
                                    source: 'github',
                                    score: calculateRelevanceScore(q, repo.name, snippet, 7)
                                });
                            }
                        });
                    } else if (source === 'devto' && Array.isArray(data)) {
                        successfulSources++;
                        data.forEach(article => {
                            const snippet = trimSnippet(article.description || `Dev.to article with ${article.positive_reactions_count || 0} reactions`);
                            if (!seenUrls.has(article.url)) {
                                seenUrls.add(article.url);
                                ranked.push({
                                    title: article.title || 'Untitled',
                                    url: article.url || '#',
                                    snippet: snippet,
                                    source: 'devto',
                                    score: calculateRelevanceScore(q, article.title, snippet, 8)
                                });
                            }
                        });
                    } else if (source === 'hackernews' && data.hits) {
                        successfulSources++;
                        data.hits.forEach(hit => {
                            const snippet = trimSnippet(`${hit.points || 0} points â€¢ ${hit.num_comments || 0} comments`);
                            const url = hit.url || `https://news.ycombinator.com/item?id=${hit.objectID || ''}`;
                            if (!seenUrls.has(url)) {
                                seenUrls.add(url);
                                ranked.push({
                                    title: hit.title || 'Untitled',
                                    url: url,
                                    snippet: snippet,
                                    source: 'hackernews',
                                    score: calculateRelevanceScore(q, hit.title, snippet, 9)
                                });
                            }
                        });
                    } else if (source === 'mozilla' && data.documents) {
                        successfulSources++;
                        data.documents.forEach(doc => {
                            const snippet = trimSnippet(doc.summary || 'MDN Web Docs');
                            const url = `https://developer.mozilla.org${doc.mdn_url || ''}`;
                            if (!seenUrls.has(url)) {
                                seenUrls.add(url);
                                ranked.push({
                                    title: doc.title || 'Untitled',
                                    url: url,
                                    snippet: snippet,
                                    source: 'mozilla',
                                    score: calculateRelevanceScore(q, doc.title, snippet, 10)
                                });
                            }
                        });
                    } else if (source === 'pixabay' && data.hits) {
                        successfulSources++;
                        data.hits.forEach(image => {
                            const snippet = trimSnippet(`${image.tags || 'Image'} â€¢ ${image.likes || 0} likes â€¢ ${image.downloads || 0} downloads`);
                            if (!seenUrls.has(image.pageURL)) {
                                seenUrls.add(image.pageURL);
                                ranked.push({
                                    title: `Image: ${image.tags || 'Pixabay Image'}`,
                                    url: image.pageURL || '#',
                                    snippet: snippet,
                                    source: 'pixabay',
                                    score: calculateRelevanceScore(q, image.tags, snippet, 11)
                                });
                            }

                            if (selected.includes('pixabay')) {
                                currentTabData.imageResults.push({
                                    ...image,
                                    source: 'Pixabay'
                                });
                            }
                        });
                    } else if (source === 'pixabay' && data.AbstractText) {
                        successfulSources++;
                        const snippet = trimSnippet(data.AbstractText || 'Image search result');
                        const url = data.AbstractURL || "#";
                        if (!seenUrls.has(url)) {
                            seenUrls.add(url);
                            ranked.push({
                                title: data.Heading || q + ' images',
                                url: url,
                                snippet: snippet,
                                source: 'pixabay',
                                score: calculateRelevanceScore(q, data.Heading || q + ' images', snippet, 11)
                            });
                        }
                    } else if (source === 'openlibrary' && data.docs) {
                        successfulSources++;
                        data.docs.forEach(book => {
                            const snippet = trimSnippet(`${book.author_name?.[0] || 'Unknown author'} â€¢ ${book.first_publish_year || 'Unknown year'}`);
                            const url = `https://openlibrary.org${book.key || ''}`;
                            if (!seenUrls.has(url)) {
                                seenUrls.add(url);
                                ranked.push({
                                    title: book.title || 'Untitled Book',
                                    url: url,
                                    snippet: snippet,
                                    source: 'openlibrary',
                                    score: calculateRelevanceScore(q, book.title, snippet, 12)
                                });
                            }
                        });
                    } else if (source === 'quotable' && data.results) {
                        successfulSources++;
                        data.results.forEach(quote => {
                            const snippet = trimSnippet(`"${quote.content}" â€” ${quote.author || 'Unknown'}`);
                            const url = `https://quotable.io/quotes/${quote._id || ''}`;
                            if (!seenUrls.has(url)) {
                                seenUrls.add(url);
                                ranked.push({
                                    title: `Quote: ${quote.author || 'Unknown'}`,
                                    url: url,
                                    snippet: snippet,
                                    source: 'quotable',
                                    score: calculateRelevanceScore(q, quote.content, snippet, 13)
                                });
                            }
                        });
                    }
                } catch (error) {
                    console.error(`Error processing ${source} results:`, error);
                }
            });

            if (isSearchStale()) return;

            ranked.sort((a, b) => (b.score || 0) - (a.score || 0));

            currentTabData.allResults = [...ranked];
            
            const elapsed = (Date.now() - startTime) / 1000;
            currentTabData.searchStats = {
                totalResults: currentTabData.allResults.length,
                searchTime: elapsed.toFixed(2),
                queryCount: queries.length,
                sourceCount: selected.length,
                respondedCount: successfulSources
            };

            if (elapsedInterval) clearInterval(elapsedInterval);

            if (isSearchStale()) return;

            currentTabData.filteredResults = [...currentTabData.allResults];
            currentTabData.currentPage = 1;

            content.innerHTML = "";

            if (currentTabData.allResults.length === 0) {
                const stats = currentTabData.searchStats;
                content.innerHTML = `
                    <div class='status'>
                        <div><i class='fa fa-search'></i> &nbsp;No results found in ${stats.searchTime}s</div>
                        <div>Searched ${stats.queryCount} ${stats.queryCount===1?'query':'queries'} across ${stats.sourceCount} sources (${stats.respondedCount} responded)${deepSearch ? ' â€¢ Deep Search enabled' : ''}</div>
                    </div>
                    <div class='status'>
                        <div>Try:</div>
                        <div>â€¢ Different search terms</div>
                        <div>â€¢ Enabling more sources in Settings</div>
                        <div>â€¢ Checking your internet connection</div>
                        <div>â€¢ Disabling proxy if enabled</div>
                    </div>
                `;
            } else {
                const status = document.createElement('div');
                status.className = 'status';
                const stats = currentTabData.searchStats;
                status.innerHTML = `
                    <div class="status-bar">
                        <div class="status-info">
                            Found <b>${stats.totalResults}</b> results in <b>${stats.searchTime}s</b> â€¢ 
                            Searched ${stats.queryCount} ${stats.queryCount===1?'query':'queries'} across ${stats.sourceCount} sources (${stats.respondedCount} responded)${deepSearch ? ' â€¢ Deep Search enabled' : ''}
                        </div>
                        <div class="page-info-right">
                            Page ${currentTabData.currentPage} of ${Math.ceil(currentTabData.allResults.length/perPage)}
                        </div>
                    </div>
                `;
                content.appendChild(status);
                
                applyFilters();
            }

            attachBookmarkListeners();
            attachCopyButtonListeners();
            attachPaginationListeners();
            updateSearchInfo();
            
            tabContents[activeTabId].type = 'search';
            saveTabData(activeTabId);
            
            if (!fromHistory) {
                const historyItem = {
                    query: q,
                    time: Date.now()
                };
                
                const existingIndex = searchHistory.findIndex(h => h.query === q);
                if (existingIndex !== -1) {
                    searchHistory.splice(existingIndex, 1);
                }
                
                searchHistory.unshift(historyItem);
                
                if (searchHistory.length > 50) {
                    searchHistory = searchHistory.slice(0, 50);
                }
            }
            
            if (cacheEnabled && !cachePaused) {
                saveSearchResults(q, currentTabData.allResults, currentTabData.imageResults, currentTabData.definitionData);
            }
        } catch (error) {
            if (elapsedInterval) clearInterval(elapsedInterval);

            console.error('Search error:', error);
            content.innerHTML = `
                <div class='status'>
                    <div><i class='fa fa-exclamation-triangle'></i> Search error</div>
                    <div>${error.message || 'Unknown error occurred'}</div>
                </div>
                <div class='status'>
                    <div>Try:</div>
                    <div>â€¢ Checking your internet connection</div>
                    <div>â€¢ Disabling proxy if enabled</div>
                    <div>â€¢ Reducing number of search sources</div>
                </div>
            `;

            attachBookmarkListeners();
            attachCopyButtonListeners();
            attachPaginationListeners();
            updateSearchInfo();
            
            saveTabData(activeTabId);
        }

        updateSearchInfo();
    }
  
</script>
</body>
</html>
